# Figma Webhooks Module - Technical Documentation

**Status:** âš ï¸ **BROKEN - MODULE IN TRANSITION STATE** âš ï¸

**Version:** 1.0.0
**Date:** 2025-11-02
**Node Requirement:** >=20.0.0

## Table of Contents

1. [Overview](#overview)
2. [Critical Warnings](#critical-warnings)
3. [Source Code Structure](#source-code-structure)
4. [Test Coverage](#test-coverage)
5. [Health Check Server](#health-check-server)
6. [Main Entry Point](#main-entry-point)
7. [Architecture](#architecture)
8. [Summary](#summary)
9. [Fix Recommendations](#fix-recommendations)

---

## Overview

The Figma Webhooks module provides a comprehensive SDK and CLI for managing Figma's Webhooks API v2, enabling automated responses to file changes, version updates, and team activity.

**Intended Capabilities:**
- Create, update, pause, activate, and delete webhooks for files, projects, and teams
- Monitor webhook delivery health with success rate tracking
- Test webhook endpoint connectivity with PING events
- Bulk operations for creating and managing multiple webhooks
- Search and filter webhooks by endpoint, event type, or status
- Verify webhook payload signatures for security
- CLI tool with 15+ commands for webhook management
- Real-time webhook request history and debugging

**Current State:** Module is **non-functional** due to broken imports and architectural violations (see Critical Warnings).

---

## Critical Warnings

### Runtime Failures

1. **âŒ BROKEN IMPORT: index.mjs references deleted client.mjs**
   - **Location:** `index.mjs:7-12`
   - **Error:** Attempts to export 4 error classes from non-existent `./client.mjs`
   - **Impact:** Module fails to load with `ERR_MODULE_NOT_FOUND`
   - **Evidence:**
   ```javascript
   export {
     WebhookError,
     WebhookAuthError,
     WebhookValidationError,
     WebhookRateLimitError
   } from './client.mjs';  // âŒ File does not exist
   ```

2. **âŒ BROKEN IMPORT: health-check-server.mjs missing FigmaApiClient**
   - **Locations:** `health-check-server.mjs:70, 99, 135, 167, 196, 225`
   - **Error:** References `FigmaApiClient` without import statement
   - **Impact:** Health check server crashes on startup
   - **Evidence:** 6 instantiations of undefined `FigmaApiClient` class

3. **âŒ ARCHITECTURAL VIOLATION: Direct undici import in SDK**
   - **Location:** `sdk.mjs:6`
   - **Error:** `import { fetch, ProxyAgent } from 'undici';`
   - **Impact:** Violates centralized HTTP client pattern (REQ003.md)
   - **Evidence:** SDK layer imports undici directly instead of using `@figma-api/fetch`
   - **Used at:** `sdk.mjs:439` in `testWebhookEndpoint()` method

### Test Coverage Failure

4. **âŒ ZERO TEST COVERAGE**
   - **Deleted files:** `client.test.mjs`, `client-proxy.test.mjs`
   - **Test infrastructure:** Jest configuration exists but no test files
   - **Impact:** No validation of SDK or CLI functionality
   - **Evidence:** `jest.config.mjs` configured to find `**/*.test.mjs` but none exist

---

## Source Code Structure

### Directory Overview

```
webhooks/
â”œâ”€â”€ index.mjs              (22 lines)   âŒ BROKEN - imports deleted client.mjs
â”œâ”€â”€ sdk.mjs                (492 lines)  âš ï¸  MIXED - has undici imports
â”œâ”€â”€ cli.mjs                (537 lines)  âœ“  Functional CLI tool
â”œâ”€â”€ health-check-server.mjs (286 lines) âŒ BROKEN - missing import
â”œâ”€â”€ jest.config.mjs        (19 lines)   âœ“  Test configuration
â”œâ”€â”€ client.mjs.bak         (backup)     Reference implementation
â””â”€â”€ package.json           (77 lines)   âœ“  Valid configuration
```

**Total Lines:** 1,353 lines of source code
**Functional Lines:** 556 lines (cli.mjs + jest.config.mjs)
**Broken Lines:** 797 lines (index.mjs, sdk.mjs, health-check-server.mjs)

---

### **index.mjs** (22 lines) âŒ BROKEN

**Location:** `webhooks/index.mjs:1`

**Purpose:** Main entry point that exports SDK and error classes for the Figma Webhooks library.

**Status:** **Non-functional** - imports from deleted file

**Exports:**

1. **Error Classes (lines 7-12)** âŒ BROKEN
   - Attempts to export from non-existent `./client.mjs`:
     - `WebhookError` - Base error class
     - `WebhookAuthError` - Authentication failures
     - `WebhookValidationError` - Invalid webhook configurations
     - `WebhookRateLimitError` - Rate limit exceeded
   - **Problem:** `client.mjs` was deleted during refactoring

2. **SDK Exports (lines 14-22)** âœ“ FUNCTIONAL
   - `FigmaWebhooksSDK` - Named export
   - `default` - Default export pointing to SDK
   - `VERSION` - Library version constant ('1.0.0')

**Fix Required:** Remove error class exports or recreate error definitions

---

### **sdk.mjs** (492 lines) âš ï¸ ARCHITECTURAL VIOLATION

**Location:** `webhooks/sdk.mjs:1`

**Purpose:** High-level SDK facade providing ergonomic API for Figma Webhooks operations with 30+ convenience methods.

**Status:** **Mixed** - Accepts fetcher via DI but also uses direct undici imports

**Key Components:**

#### 1. Constructor (lines 19-46)
**Signature:** `constructor({ fetcher, logger = console, proxyUrl, proxyToken } = {})`

**Parameters:**
- `fetcher` - **Required** FigmaApiClient instance (dependency injection)
- `logger` - Optional custom logger (default: console)
- `proxyUrl` - Optional HTTP proxy URL
- `proxyToken` - Optional proxy authentication token

**Architectural Issue:**
```javascript
import { fetch, ProxyAgent } from 'undici';  // âŒ Line 6 - VIOLATION

constructor({ fetcher, logger = console, proxyUrl, proxyToken } = {}) {
  if (!fetcher) {
    throw new Error('fetcher parameter is required...');
  }
  this.fetcher = fetcher;  // âœ“ Good - stores injected fetcher

  // âŒ Bad - creates own ProxyAgent instead of using fetcher's proxy
  this.proxyAgent = finalProxyUrl
    ? new ProxyAgent({ uri: finalProxyUrl, token: finalProxyToken })
    : null;
}
```

**Problem:** Accepts `fetcher` (good) but also imports and uses undici directly (bad)

#### 2. Webhook Management Methods (lines 48-226)

**File Webhooks:**
- `createFileWebhook({ fileKey, endpoint, passcode, description, active })` (lines 60-76)
  - Creates webhook for FILE_UPDATE events
  - Uses `this.fetcher.createWebhook()` âœ“ Correct

**Project Webhooks:**
- `createProjectWebhook({ projectId, eventType, endpoint, passcode, ... })` (lines 89-106)
  - Creates webhook for all files in a project
  - Default event: FILE_UPDATE

**Team Webhooks:**
- `createTeamWebhook({ teamId, eventType, endpoint, passcode, ... })` (lines 119-136)
  - Creates webhook for team-wide activity

**CRUD Operations:**
- `getWebhook(webhookId)` (lines 143-152) - Returns null on 404
- `listWebhooks(options)` (lines 162-165) - Filters by context/contextId/planApiId
- `listAllWebhooks(planApiId)` (lines 172-180) - Paginated retrieval
- `updateWebhook(webhookId, updates)` (lines 188-190)
- `deleteWebhook(webhookId)` (lines 197-207) - Returns boolean
- `pauseWebhook(webhookId)` (lines 214-216)
- `activateWebhook(webhookId)` (lines 223-225)

**All CRUD methods correctly use `this.fetcher.*` âœ“**

#### 3. Webhook Monitoring Methods (lines 228-286)

- `getWebhookHistory(webhookId)` (lines 234-237)
  - Returns recent webhook delivery attempts
  - Uses `this.fetcher.getWebhookRequests()` âœ“

- `checkWebhookHealth(webhookId)` (lines 244-285)
  - Analyzes delivery success rates
  - Returns: `{ status, message, successRate, lastDelivery, totalRequests, ... }`
  - Health states: 'unknown', 'healthy', 'degraded', 'failing'
  - Degraded threshold: <80% success rate
  - Uses fetcher correctly âœ“

#### 4. Bulk Operations (lines 288-376)

- `createBulkWebhooks(contextIds, webhookConfig)` (lines 299-322)
  - Creates multiple webhooks with same configuration
  - Returns: `{ created: [], errors: [] }`

- `deleteBulkWebhooks(webhookIds)` (lines 329-348)
- `pauseBulkWebhooks(webhookIds)` (lines 356-376)

**All bulk operations use `this.fetcher.*` âœ“**

#### 5. Webhook Discovery Methods (lines 378-411)

- `findWebhooksByEndpoint(endpoint, planApiId)` (lines 386-389)
- `findWebhooksByEventType(eventType, planApiId)` (lines 397-400)
- `findInactiveWebhooks(planApiId)` (lines 407-410)

**All discovery methods use `this.fetcher.*` âœ“**

#### 6. Convenience Methods (lines 413-490)

**Endpoint Testing (lines 419-453)** âŒ ARCHITECTURAL VIOLATION
```javascript
async testWebhookEndpoint(endpoint) {
  try {
    const fetchOptions = {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Figma-Event': 'PING'
      },
      body: JSON.stringify({ ... })
    };

    if (this.proxyAgent) {
      fetchOptions.dispatcher = this.proxyAgent;  // âŒ Uses undici ProxyAgent
    }

    const response = await fetch(endpoint, fetchOptions);  // âŒ Direct undici fetch

    return {
      reachable: true,
      status: response.status,
      statusText: response.statusText,
      headers: Object.fromEntries(response.headers.entries())
    };
  } catch (error) {
    return { reachable: false, error: error.message };
  }
}
```

**Problem:** This method bypasses `@figma-api/fetch` and uses undici directly. Should use `this.fetcher` with custom fetch adapter.

**Other Convenience Methods:**
- `verifySignature(payload, signature, passcode)` (lines 462-464)
  - Delegates to `this.fetcher.verifyWebhookSignature()` âœ“
- `getSupportedEventTypes()` (lines 470-472)
- `getSupportedContextTypes()` (lines 478-480)
- `close()` (lines 486-489) - Resource cleanup

**Dependencies:**
- `@figma-api/fetch` (peer dependency) - Used correctly in 95% of methods
- `undici` - **Should not be direct dependency** (architectural violation)

**Architecture Pattern:** **Inconsistent Dependency Injection**
- Accepts `fetcher` in constructor âœ“
- Uses `this.fetcher` for all Figma API calls âœ“
- But also imports and uses undici directly for endpoint testing âŒ

---

### **cli.mjs** (537 lines) âœ“ FUNCTIONAL

**Location:** `webhooks/cli.mjs:1`

**Purpose:** Command-line interface for Figma Webhooks API v2 with 15 commands for webhook lifecycle management.

**Status:** **Functional** (assuming SDK is fixed)

**CLI Configuration:**

**Program Setup (lines 14-22):**
```javascript
program
  .name('figma-webhooks')
  .description('CLI for Figma Webhooks API v2')
  .version('1.0.0')
  .option('-t, --token <token>', 'Figma API token (or set FIGMA_TOKEN env var)')
  .option('-b, --base-url <url>', 'API base URL', 'https://api.figma.com')
  .option('-v, --verbose', 'Verbose output')
  .option('--json', 'Output as JSON');
```

**Key Components:**

#### 1. Helpers (lines 24-74)

**getSDK(options)** (lines 25-40):
- Retrieves API token from `--token` flag or `FIGMA_TOKEN` env var
- Creates FigmaWebhooksSDK instance
- âš ï¸ **Issue:** Instantiates SDK with `{ apiToken, baseUrl, logger }` but SDK constructor expects `{ fetcher }` (lines 35-39)
- **Problem:** CLI doesn't create FigmaApiClient before passing to SDK

**formatOutput(data, options)** (lines 43-57):
- JSON mode: `JSON.stringify(data, null, 2)`
- Array mode: Formats each webhook with `formatWebhook()`
- Single item mode: Formats single webhook

**formatWebhook(webhook)** (lines 60-74):
- Returns: `{id} | {event_type} | {status} | {context}:{context_id} | {endpoint}`
- Uses chalk for colorization (blue IDs, green ACTIVE, yellow PAUSED)

#### 2. Webhook Management Commands (lines 76-247)

**list** (lines 79-112):
- Options: `--context`, `--context-id`, `--plan`
- Lists all webhooks with optional filtering
- Uses `sdk.listAllWebhooks()` or `sdk.listWebhooks()`

**get <webhook-id>** (lines 115-140):
- Retrieves single webhook by ID
- Exits with code 1 if not found

**create** (lines 143-178):
- Required: `--event`, `--context`, `--context-id`, `--endpoint`, `--passcode`
- Optional: `--description`, `--paused`
- âš ï¸ **Issue:** Calls `sdk.client.createWebhook()` (line 159) but SDK doesn't expose `client` property

**update <webhook-id>** (lines 181-213):
- Partial updates: `--event`, `--endpoint`, `--passcode`, `--description`, `--status`
- Uses `sdk.updateWebhook()` âœ“

**delete <webhook-id>** (lines 216-247):
- Requires `--force` flag for confirmation
- Safety feature prevents accidental deletion

#### 3. Webhook Control Commands (lines 249-293)

**pause <webhook-id>** (lines 252-271):
- Sets webhook status to PAUSED
- Uses `sdk.pauseWebhook()` âœ“

**activate <webhook-id>** (lines 274-293):
- Sets webhook status to ACTIVE
- Uses `sdk.activateWebhook()` âœ“

#### 4. Monitoring Commands (lines 295-379)

**history <webhook-id>** (lines 298-332):
- Shows recent webhook delivery attempts
- Formats with âœ“/âœ—/? status indicators
- Displays error messages if present

**health <webhook-id>** (lines 335-379):
- Runs health check analysis
- Shows status (HEALTHY/DEGRADED/FAILING/UNKNOWN)
- Displays success rate, total/successful/failed requests
- Color-coded output (green/yellow/red/gray)

#### 5. Utility Commands (lines 381-475)

**test-endpoint <url>** (lines 384-411):
- Tests webhook endpoint connectivity
- Sends PING event
- Shows HTTP status and reachability

**search** (lines 414-451):
- Required: `--plan`
- Options: `--endpoint`, `--event-type`, `--inactive`
- Searches across all webhooks in plan

**info** (lines 454-475):
- Shows supported event types and context types
- Calls `sdk.getSupportedEventTypes()` and `sdk.getSupportedContextTypes()`

#### 6. Bulk Operations (lines 477-529)

**bulk-create** (lines 480-529):
- Reads JSON file with `{ contextIds: [...], config: {...} }`
- Creates multiple webhooks with same configuration
- Reports successes and errors separately

**Dependencies:**
- `commander` - CLI framework
- `chalk` - Terminal color output
- `ora` - Spinner animations
- `./sdk.mjs` - FigmaWebhooksSDK

**Usage Examples:**
```bash
# List all webhooks in a team
figma-webhooks list --context team --context-id 123456

# Create file webhook
figma-webhooks create \
  --event FILE_UPDATE \
  --context file \
  --context-id abc123 \
  --endpoint https://example.com/webhook \
  --passcode secret

# Check webhook health
figma-webhooks health wh_abc123

# Search by endpoint
figma-webhooks search --plan plan123 --endpoint https://example.com/webhook
```

**Known Issues:**
1. âš ï¸ `getSDK()` creates SDK without proper `fetcher` parameter (line 35)
2. âš ï¸ `create` command references `sdk.client.createWebhook()` instead of SDK method (line 159)

---

### **health-check-server.mjs** (286 lines) âŒ BROKEN

**Location:** `webhooks/health-check-server.mjs:1`

**Purpose:** Fastify-based HTTP server providing health checks and example webhook API endpoints.

**Status:** **Non-functional** - Missing critical import

**Server Configuration:**
- **Port:** 3009 (configurable via `PORT` env var)
- **Host:** 0.0.0.0 (all interfaces)
- **Logger:** Fastify built-in logger

**Endpoints:**

#### 1. Root Health Check (lines 17-48)
**Route:** `GET /`

**Response:**
```json
{
  "module": "figma-webhooks",
  "version": "1.0.0",
  "status": "healthy" | "unhealthy",
  "environment": {
    "FIGMA_TOKEN": "present" | "missing"
  },
  "endpoints": [ ... ],
  "availableMethods": [ ... ]
}
```

**Status Check:** Validates `FIGMA_TOKEN` environment variable presence

#### 2. Test Endpoint (lines 51-86) âŒ BROKEN
**Route:** `GET /test?teamId=...`

**Purpose:** Tests SDK initialization and API connectivity

**Problem (line 70):**
```javascript
const sdk = new FigmaWebhooksSDK({
  fetcher: new FigmaApiClient({ apiToken: FIGMA_TOKEN })  // âŒ FigmaApiClient undefined
});
```

**Missing Import:** File lacks `import { FigmaApiClient } from '@figma-api/fetch';`

**Expected Response:**
```json
{
  "success": true,
  "message": "Successfully connected to Figma API",
  "teamId": "123456",
  "webhooksCount": 5
}
```

#### 3. List Team Webhooks (lines 89-114) âŒ BROKEN
**Route:** `GET /webhooks/team/:teamId`

**Problem (line 99):** Same missing `FigmaApiClient` import

#### 4. Create Webhook (lines 117-152) âŒ BROKEN
**Route:** `POST /webhooks`

**Body:**
```json
{
  "teamId": "123456",
  "eventType": "FILE_UPDATE",
  "endpoint": "https://example.com/webhook",
  "passcode": "secret",
  "description": "Optional description"
}
```

**Problem (line 135):** Missing `FigmaApiClient` import

#### 5. Update Webhook (lines 155-182) âŒ BROKEN
**Route:** `PUT /webhooks/:webhookId`

**Problem (line 167):** Missing `FigmaApiClient` import

#### 6. Delete Webhook (lines 185-211) âŒ BROKEN
**Route:** `DELETE /webhooks/:webhookId`

**Problem (line 196):** Missing `FigmaApiClient` import

#### 7. Get Webhook Requests (lines 214-240) âŒ BROKEN
**Route:** `GET /webhooks/:webhookId/requests`

**Problem (line 225):** Missing `FigmaApiClient` import

#### 8. Verify Webhook Payload (lines 243-269) âš ï¸ PARTIAL
**Route:** `POST /webhooks/verify`

**Body:**
```json
{
  "payload": "...",
  "signature": "...",
  "passcode": "..."
}
```

**Problem (line 254):** Instantiates SDK with `{ token }` instead of `{ fetcher }`

**Server Startup (lines 272-285):**
```javascript
const start = async () => {
  await fastify.listen({ port: PORT, host: '0.0.0.0' });
  console.log(`ğŸš€ Figma Webhooks Health Check Server running on port ${PORT}`);
  console.log(`   FIGMA_TOKEN: ${FIGMA_TOKEN ? 'âœ“ Set' : 'âœ— Not set'}`);
};
start();
```

**Fix Required:**
```javascript
// Add at top of file
import { FigmaApiClient } from '@figma-api/fetch';
```

**Dependencies:**
- `fastify` - Web framework
- `./index.mjs` - FigmaWebhooksSDK import âœ“
- `@figma-api/fetch` - **MISSING IMPORT** âŒ

---

### **jest.config.mjs** (19 lines) âœ“ FUNCTIONAL

**Location:** `webhooks/jest.config.mjs:1`

**Purpose:** Jest test configuration extending shared base configuration.

**Configuration:**

```javascript
import baseConfig from '../jest.base.config.mjs';

export default {
  ...baseConfig,
  displayName: 'webhooks',
  testMatch: [
    '<rootDir>/**/*.test.mjs'  // Matches all .test.mjs files
  ],
  collectCoverageFrom: [
    '*.mjs',           // All .mjs files
    '!cli.mjs',        // Exclude CLI from coverage
    '!jest.config.mjs' // Exclude config from coverage
  ]
};
```

**Test Discovery:**
- Pattern: `**/*.test.mjs` (any .test.mjs file in any subdirectory)
- **Problem:** No test files exist (all deleted during refactoring)

**Coverage Collection:**
- Includes: All `.mjs` files in root directory
- Excludes: `cli.mjs` (CLI tool), `jest.config.mjs` (config file)
- **Issue:** Configuration is valid but coverage will be 0% (no tests)

**Base Configuration:** Inherits from `../jest.base.config.mjs`

---

### **package.json** (77 lines) âœ“ VALID

**Location:** `webhooks/package.json:1`

**Package Metadata:**
- **Name:** `figma-webhooks`
- **Version:** 1.0.0
- **Type:** `module` (ES modules)
- **Main:** `./index.mjs`
- **Types:** `./index.d.mts`
- **Bin:** `figma-webhooks` â†’ `cli.mjs`

**Exports (lines 8-14):**
```json
{
  ".": {
    "types": "./index.d.mts",
    "import": "./index.mjs"
  },
  "./package.json": "./package.json"
}
```

**Scripts (lines 18-26):**
- `build` - No-op (ES modules don't require build)
- `test` - Jest with experimental VM modules
- `test:watch` - Watch mode
- `test:coverage` - Coverage reporting
- `lint` - ESLint
- `format` - Prettier
- `start` - Shows CLI help

**Dependencies (lines 54-59):**
- `chalk@^5.3.0` - Terminal colors
- `commander@^12.0.0` - CLI framework
- `ora@^8.0.1` - Spinners
- `undici@^6.21.0` - **âŒ SHOULD BE REMOVED** (architectural violation)

**Peer Dependencies (lines 51-53):**
```json
{
  "peerDependencies": {
    "@figma-api/fetch": "file:../figma-fetch"  // âœ“ Correct
  }
}
```

**Dev Dependencies (lines 60-67):**
- `@figma-api/fetch` - Local peer dependency
- `@jest/globals@^29.7.0` - Jest types
- `eslint@^8.57.0` - Linting
- `fastify@^5.6.1` - Health check server
- `jest@^29.7.0` - Testing framework
- `prettier@^3.2.5` - Code formatting

**Engines (lines 47-50):**
- **Node:** >=20.0.0
- **NPM:** >=9.0.0

**Repository (lines 68-72):**
- **URL:** `git+https://github.com/thinkeloquent/figma-api-module.git`
- **Directory:** `mjs/webhooks`

---

## Test Coverage

**Status:** âŒ **0% COVERAGE - NO TESTS EXIST**

### Deleted Test Files

According to git status, the following test files were deleted:
1. `tests/unit/client.test.mjs` - Client layer tests (deleted)
2. `tests/unit/client-proxy.test.mjs` - Proxy functionality tests (deleted)

### Test Infrastructure

**Test Configuration:** `jest.config.mjs` (19 lines)
- Display name: 'webhooks'
- Test pattern: `<rootDir>/**/*.test.mjs`
- Coverage includes: All `.mjs` files except `cli.mjs` and `jest.config.mjs`
- Base config: Extends `../jest.base.config.mjs`

**Test Discovery Pattern:** `**/*.test.mjs`
**Actual Test Files:** **0 files**
**Test Lines:** **0 lines**
**Coverage:** **0%** (statement, branch, function, line)

### Missing Test Coverage

**Required Test Suites:**

1. **SDK Tests** (sdk.test.mjs) - **MISSING**
   - Should cover 30+ SDK methods:
     - Webhook CRUD operations
     - Bulk operations
     - Health monitoring
     - Webhook discovery
     - Signature verification
     - Endpoint testing
   - Should test fetcher dependency injection
   - Should mock FigmaApiClient responses

2. **CLI Tests** (cli.test.mjs) - **MISSING**
   - Should cover 15 commands:
     - list, get, create, update, delete
     - pause, activate
     - history, health
     - test-endpoint, search, info
     - bulk-create
   - Should test argument parsing
   - Should test output formatting (JSON and text)

3. **Health Check Server Tests** (health-check-server.test.mjs) - **MISSING**
   - Should cover 8 endpoints
   - Should test with/without FIGMA_TOKEN
   - Should test error responses

4. **Integration Tests** - **MISSING**
   - End-to-end webhook lifecycle
   - Bulk operations
   - Error handling across layers

### Test Framework Setup

**Testing Tools:**
- **Framework:** Jest 29.7.0
- **Globals:** `@jest/globals@^29.7.0`
- **Runner:** Node experimental VM modules
- **Command:** `node --experimental-vm-modules ../node_modules/.bin/jest`

### Impact of Missing Tests

**Risks:**
- âŒ No validation of SDK method behavior
- âŒ No regression detection for bug fixes
- âŒ No verification of error handling
- âŒ No confidence in refactoring safety
- âŒ No documentation via test examples
- âŒ Cannot verify fixes for broken imports

**Recommended Test Structure:**

```
webhooks/
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/
â”‚   â”‚   â”œâ”€â”€ sdk.test.mjs           (SDK methods)
â”‚   â”‚   â”œâ”€â”€ cli.test.mjs           (CLI commands)
â”‚   â”‚   â””â”€â”€ health-check.test.mjs  (Server endpoints)
â”‚   â””â”€â”€ integration/
â”‚       â””â”€â”€ webhook-lifecycle.test.mjs (E2E scenarios)
```

**Example Test Case (sdk.test.mjs):**
```javascript
import { describe, it, expect, jest } from '@jest/globals';
import { FigmaWebhooksSDK } from '../sdk.mjs';

describe('FigmaWebhooksSDK', () => {
  it('should require fetcher parameter', () => {
    expect(() => new FigmaWebhooksSDK({})).toThrow(
      'fetcher parameter is required'
    );
  });

  it('should create file webhook', async () => {
    const mockFetcher = {
      createWebhook: jest.fn().mockResolvedValue({ id: 'wh_123' })
    };

    const sdk = new FigmaWebhooksSDK({ fetcher: mockFetcher });
    const webhook = await sdk.createFileWebhook({
      fileKey: 'abc123',
      endpoint: 'https://example.com/webhook',
      passcode: 'secret'
    });

    expect(webhook.id).toBe('wh_123');
    expect(mockFetcher.createWebhook).toHaveBeenCalledWith({
      eventType: 'FILE_UPDATE',
      context: 'file',
      contextId: 'abc123',
      endpoint: 'https://example.com/webhook',
      passcode: 'secret',
      status: 'ACTIVE',
      description: undefined
    });
  });
});
```

---

## Health Check Server

**Location:** `webhooks/health-check-server.mjs:1`
**Status:** âŒ **BROKEN - Missing FigmaApiClient import**
**Port:** 3009 (configurable via `PORT` env var)
**Framework:** Fastify 5.6.1

### Server Overview

The health check server provides HTTP endpoints for:
1. Module health status monitoring
2. SDK functionality testing
3. Example webhook API operations
4. Webhook payload verification

**Startup:**
```bash
# Set environment variable
export FIGMA_TOKEN=your_figma_token_here

# Start server
node health-check-server.mjs
```

**Expected Output:**
```
ğŸš€ Figma Webhooks Health Check Server running on port 3009
   Health check: http://localhost:3009/
   Test endpoint: http://localhost:3009/test
   FIGMA_TOKEN: âœ“ Set
```

### Endpoints

#### 1. GET / - Health Check
**Purpose:** Module status and capability overview

**Response (200 OK):**
```json
{
  "module": "figma-webhooks",
  "version": "1.0.0",
  "status": "healthy",
  "environment": {
    "FIGMA_TOKEN": "present"
  },
  "endpoints": [
    "GET / - Health check and module information",
    "GET /test - Test Figma API connectivity",
    "GET /webhooks/team/:teamId - List team webhooks (example)",
    "POST /webhooks - Create webhook (example)",
    "PUT /webhooks/:webhookId - Update webhook (example)",
    "DELETE /webhooks/:webhookId - Delete webhook (example)",
    "GET /webhooks/:webhookId/requests - Get webhook requests (example)",
    "POST /webhooks/verify - Verify webhook payload (example)"
  ],
  "availableMethods": [
    "listWebhooks(teamId)",
    "getWebhook(webhookId)",
    "createWebhook(teamId, eventType, endpoint, options)",
    "updateWebhook(webhookId, updates)",
    "deleteWebhook(webhookId)",
    "getWebhookRequests(webhookId)",
    "testWebhook(webhookId)",
    "verifyWebhookSignature(payload, signature, passcode)"
  ]
}
```

**Status Determination:**
- **healthy:** `FIGMA_TOKEN` environment variable is set
- **unhealthy:** `FIGMA_TOKEN` is missing

#### 2. GET /test - API Connectivity Test
**Purpose:** Validate SDK initialization and Figma API access

**Query Parameters:**
- `teamId` (optional) - Team ID to test webhook listing

**Without teamId:**
```bash
curl http://localhost:3009/test
```

**Response (200 OK):**
```json
{
  "success": true,
  "message": "SDK initialized successfully. Provide ?teamId=YOUR_TEAM_ID to test API connectivity",
  "tokenPresent": true
}
```

**With teamId:**
```bash
curl http://localhost:3009/test?teamId=123456
```

**Response (200 OK):**
```json
{
  "success": true,
  "message": "Successfully connected to Figma API",
  "teamId": "123456",
  "webhooksCount": 5
}
```

**Error Response (400 Bad Request):**
```json
{
  "success": false,
  "error": "FIGMA_TOKEN environment variable not set"
}
```

**Implementation Issue (line 70):** âŒ Missing `FigmaApiClient` import causes crash

#### 3. GET /webhooks/team/:teamId - List Team Webhooks
**Purpose:** Example endpoint for retrieving webhooks

**Request:**
```bash
curl http://localhost:3009/webhooks/team/123456
```

**Response (200 OK):**
```json
{
  "success": true,
  "teamId": "123456",
  "webhooks": [
    {
      "id": "wh_abc123",
      "event_type": "FILE_UPDATE",
      "context": "team",
      "context_id": "123456",
      "endpoint": "https://example.com/webhook",
      "status": "ACTIVE"
    }
  ]
}
```

**Implementation:** `health-check-server.mjs:89-114`
**Issue (line 99):** âŒ Missing `FigmaApiClient` import

#### 4. POST /webhooks - Create Webhook
**Purpose:** Example endpoint for webhook creation

**Request Body:**
```json
{
  "teamId": "123456",
  "eventType": "FILE_UPDATE",
  "endpoint": "https://example.com/webhook",
  "passcode": "your_secret_passcode",
  "description": "Production webhook for file updates"
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "webhook": {
    "id": "wh_abc123",
    "event_type": "FILE_UPDATE",
    "context": "team",
    "context_id": "123456",
    "endpoint": "https://example.com/webhook",
    "status": "ACTIVE",
    "description": "Production webhook for file updates"
  }
}
```

**Error Response (400 Bad Request):**
```json
{
  "success": false,
  "error": "Missing required fields: teamId, eventType, endpoint"
}
```

**Implementation:** `health-check-server.mjs:117-152`
**Issue (line 135):** âŒ Missing `FigmaApiClient` import

#### 5. PUT /webhooks/:webhookId - Update Webhook
**Purpose:** Example endpoint for webhook updates

**Request:**
```bash
curl -X PUT http://localhost:3009/webhooks/wh_abc123 \
  -H "Content-Type: application/json" \
  -d '{"endpoint": "https://new-endpoint.com/webhook"}'
```

**Request Body (partial updates):**
```json
{
  "endpoint": "https://new-endpoint.com/webhook",
  "status": "PAUSED"
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "webhookId": "wh_abc123",
  "webhook": {
    "id": "wh_abc123",
    "endpoint": "https://new-endpoint.com/webhook",
    "status": "PAUSED"
  }
}
```

**Implementation:** `health-check-server.mjs:155-182`
**Issue (line 167):** âŒ Missing `FigmaApiClient` import

#### 6. DELETE /webhooks/:webhookId - Delete Webhook
**Purpose:** Example endpoint for webhook deletion

**Request:**
```bash
curl -X DELETE http://localhost:3009/webhooks/wh_abc123
```

**Response (200 OK):**
```json
{
  "success": true,
  "webhookId": "wh_abc123",
  "message": "Webhook deleted successfully"
}
```

**Implementation:** `health-check-server.mjs:185-211`
**Issue (line 196):** âŒ Missing `FigmaApiClient` import

#### 7. GET /webhooks/:webhookId/requests - Get Webhook Requests
**Purpose:** Retrieve webhook delivery history

**Request:**
```bash
curl http://localhost:3009/webhooks/wh_abc123/requests
```

**Response (200 OK):**
```json
{
  "success": true,
  "webhookId": "wh_abc123",
  "requests": [
    {
      "request_info": {
        "sent_at": "2025-11-02T10:30:00Z"
      },
      "response_info": {
        "status": 200
      }
    }
  ]
}
```

**Implementation:** `health-check-server.mjs:214-240`
**Issue (line 225):** âŒ Missing `FigmaApiClient` import

#### 8. POST /webhooks/verify - Verify Webhook Payload
**Purpose:** Validate webhook signature without FIGMA_TOKEN requirement

**Request Body:**
```json
{
  "payload": "{\"event_type\":\"FILE_UPDATE\",\"file_key\":\"abc123\"}",
  "signature": "sha256=...",
  "passcode": "your_secret_passcode"
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "isValid": true,
  "message": "Signature is valid"
}
```

**Invalid Signature Response:**
```json
{
  "success": true,
  "isValid": false,
  "message": "Signature is invalid"
}
```

**Implementation:** `health-check-server.mjs:243-269`
**Issue (line 254):** âš ï¸ SDK instantiated with `{ token }` instead of `{ fetcher }`

### Dependencies

**Runtime:**
- `fastify@^5.6.1` - Web framework
- `./index.mjs` - FigmaWebhooksSDK
- `@figma-api/fetch` - **MISSING IMPORT** âŒ

**Environment Variables:**
- `PORT` - Server port (default: 3009)
- `FIGMA_TOKEN` - Figma API token (required for most endpoints)

### Running the Server

**Installation:**
```bash
cd webhooks
npm install
```

**Start Server:**
```bash
export FIGMA_TOKEN=your_token_here
node health-check-server.mjs
```

**Access:**
- Health check: http://localhost:3009/
- Test connectivity: http://localhost:3009/test?teamId=YOUR_TEAM_ID
- API documentation: http://localhost:3009/ (lists all endpoints)

### Critical Fixes Required

**Fix 1: Add Missing Import**
```javascript
// Add at top of health-check-server.mjs
import { FigmaApiClient } from '@figma-api/fetch';
```

**Fix 2: Update Verification Endpoint**
```javascript
// Line 254 - Change from:
const sdk = new FigmaWebhooksSDK({ token: FIGMA_TOKEN || 'dummy' });

// To:
const fetcher = new FigmaApiClient({ apiToken: FIGMA_TOKEN || 'dummy' });
const sdk = new FigmaWebhooksSDK({ fetcher });
```

---

## Main Entry Point

**Location:** `webhooks/index.mjs:1`
**Status:** âŒ **BROKEN - Imports from deleted file**
**Lines:** 22

### Module Exports

The main entry point exports the public API surface for the Figma Webhooks library:

#### 1. Error Classes (lines 7-12) âŒ BROKEN

**Export Statement:**
```javascript
export {
  WebhookError,
  WebhookAuthError,
  WebhookValidationError,
  WebhookRateLimitError
} from './client.mjs';  // âŒ File does not exist
```

**Problem:** The file `client.mjs` was deleted during refactoring, but exports remain.

**Expected Error Classes:**
1. `WebhookError` - Base error class for all webhook operations
2. `WebhookAuthError` - Authentication/authorization failures (401, 403)
3. `WebhookValidationError` - Invalid webhook configuration or parameters
4. `WebhookRateLimitError` - Figma API rate limit exceeded (429)

**Error Hierarchy (from backup file `client.mjs.bak`):**
```
Error
â””â”€â”€ WebhookError (base)
    â”œâ”€â”€ WebhookAuthError
    â”œâ”€â”€ WebhookValidationError
    â””â”€â”€ WebhookRateLimitError
```

**Usage (if working):**
```javascript
import { WebhookError, WebhookAuthError } from 'figma-webhooks';

try {
  await sdk.createFileWebhook({ ... });
} catch (error) {
  if (error instanceof WebhookAuthError) {
    console.error('Authentication failed:', error.message);
  }
}
```

#### 2. SDK Exports (lines 14-22) âœ“ FUNCTIONAL

**Named Export:**
```javascript
export { FigmaWebhooksSDK } from './sdk.mjs';
```

**Default Export:**
```javascript
export { default as FigmaWebhooksSDK } from './sdk.mjs';
export { default } from './sdk.mjs';
```

**Version Export:**
```javascript
export const VERSION = '1.0.0';
```

**Usage:**
```javascript
// Named import
import { FigmaWebhooksSDK } from 'figma-webhooks';

// Default import
import FigmaWebhooksSDK from 'figma-webhooks';

// Version check
import { VERSION } from 'figma-webhooks';
console.log(`Using figma-webhooks v${VERSION}`);
```

### Package Configuration

**package.json** (relevant sections):

**Main Entry Points (lines 5-14):**
```json
{
  "main": "./index.mjs",
  "types": "./index.d.mts",
  "exports": {
    ".": {
      "types": "./index.d.mts",
      "import": "./index.mjs"
    },
    "./package.json": "./package.json"
  }
}
```

**Binary Entry Point (lines 15-17):**
```json
{
  "bin": {
    "figma-webhooks": "cli.mjs"
  }
}
```

**Module Type:**
```json
{
  "type": "module"  // ES modules enabled
}
```

### Initialization Requirements

**Correct Usage (once fixed):**
```javascript
import { FigmaApiClient } from '@figma-api/fetch';
import { FigmaWebhooksSDK } from 'figma-webhooks';

// Step 1: Create HTTP client with API token
const fetcher = new FigmaApiClient({
  apiToken: process.env.FIGMA_TOKEN
});

// Step 2: Create SDK with injected fetcher
const sdk = new FigmaWebhooksSDK({ fetcher });

// Step 3: Use SDK methods
const webhooks = await sdk.listWebhooks({ context: 'team', contextId: '123456' });
```

**CLI Installation:**
```bash
# Install globally
npm install -g figma-webhooks

# Or use locally
npx figma-webhooks --help
```

**CLI Usage:**
```bash
# Set token via environment variable
export FIGMA_TOKEN=your_figma_token_here

# Or pass via flag
figma-webhooks list --token your_figma_token_here --context team --context-id 123456
```

### Fix Requirements

**Option 1: Remove Error Exports**
```javascript
// Delete lines 6-12
// Remove error class exports entirely
```

**Option 2: Recreate Error Classes**
```javascript
// Create new file: errors.mjs
export class WebhookError extends Error {
  constructor(message, { code, meta } = {}) {
    super(message);
    this.name = 'WebhookError';
    this.code = code;
    this.meta = meta;
  }
}

export class WebhookAuthError extends WebhookError {
  constructor(message, options) {
    super(message, options);
    this.name = 'WebhookAuthError';
  }
}

export class WebhookValidationError extends WebhookError {
  constructor(message, options) {
    super(message, options);
    this.name = 'WebhookValidationError';
  }
}

export class WebhookRateLimitError extends WebhookError {
  constructor(message, options) {
    super(message, options);
    this.name = 'WebhookRateLimitError';
  }
}

// Update index.mjs line 12
export {
  WebhookError,
  WebhookAuthError,
  WebhookValidationError,
  WebhookRateLimitError
} from './errors.mjs';  // Changed from './client.mjs'
```

**Recommended:** Option 2 - Recreate error classes for better error handling

---

## Architecture

### Current (Broken) Architecture

The webhooks module is in a **transition state** with inconsistent architectural patterns:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLI (cli.mjs)                                          â”‚ â† User Interface Layer
â”‚  - 15 commands                                          â”‚   âŒ BROKEN: getSDK() doesn't create fetcher
â”‚  - Formatting, validation                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SDK (sdk.mjs)                                          â”‚ â† Facade Layer
â”‚  - 30+ convenience methods                              â”‚   âš ï¸  MIXED: Accepts fetcher but also
â”‚  - Bulk operations                                      â”‚         imports undici directly
â”‚  - Health monitoring                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  @figma-api/fetch (peer dependency)                     â”‚ â† HTTP Client Layer (Intended)
â”‚  - Rate limiting (60 req/min)                           â”‚   âœ“ Used in 95% of SDK methods
â”‚  - Request caching (LRU, 5 min TTL)                     â”‚   âŒ Bypassed in testWebhookEndpoint()
â”‚  - Retry logic (exponential backoff)                    â”‚
â”‚  - Proxy support                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  undici                                                 â”‚ â† Direct HTTP (Violation)
â”‚  - fetch(), ProxyAgent                                  â”‚   âŒ Imported in sdk.mjs:6
â”‚  - Used in testWebhookEndpoint()                        â”‚   âŒ Should be removed
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Figma Webhooks API v2                                  â”‚ â† External Service
â”‚  - Webhook CRUD operations                              â”‚
â”‚  - Request history                                      â”‚
â”‚  - Signature verification                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Intended (REQ003.md Compliant) Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLI (cli.mjs)                                          â”‚ â† User Interface Layer
â”‚  - Creates FigmaApiClient                               â”‚
â”‚  - Injects fetcher into SDK                             â”‚
â”‚  - Formats output, handles errors                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SDK (sdk.mjs)                                          â”‚ â† Facade Layer
â”‚  - Receives fetcher via dependency injection            â”‚
â”‚  - Provides 30+ convenience methods                     â”‚
â”‚  - NO direct HTTP library imports                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  @figma-api/fetch                                       â”‚ â† HTTP Client Layer (Centralized)
â”‚  - FigmaApiClient                                       â”‚
â”‚  - RateLimiter (60 req/min, 10 burst)                   â”‚
â”‚  - RequestCache (LRU, 100 items, 5 min TTL)             â”‚
â”‚  - RetryHandler (3 retries, exponential backoff)        â”‚
â”‚  - ProxyAgent support                                   â”‚
â”‚  - Interceptor chains                                   â”‚
â”‚  - Error hierarchy (NetworkError, RateLimitError, etc.) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Figma Webhooks API v2                                  â”‚ â† External Service
â”‚  - POST /v2/webhooks                                    â”‚
â”‚  - GET /v2/webhooks/:id                                 â”‚
â”‚  - PUT /v2/webhooks/:id                                 â”‚
â”‚  - DELETE /v2/webhooks/:id                              â”‚
â”‚  - GET /v2/webhooks/:id/requests                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Design Patterns

#### 1. Dependency Injection Pattern âš ï¸ PARTIAL

**Where Applied:** `sdk.mjs:28-46` (constructor)

**Current Implementation:**
```javascript
export class FigmaWebhooksSDK {
  constructor({ fetcher, logger = console, proxyUrl, proxyToken } = {}) {
    if (!fetcher) {
      throw new Error('fetcher parameter is required...');
    }
    this.fetcher = fetcher;  // âœ“ Stores injected dependency

    // âŒ But also creates own ProxyAgent
    this.proxyAgent = new ProxyAgent(finalProxyUrl);
  }
}
```

**Problem:** Accepts fetcher (good) but also manages its own proxy agent (bad)

**Intended Implementation:**
```javascript
export class FigmaWebhooksSDK {
  constructor({ fetcher, logger = console } = {}) {
    if (!fetcher) {
      throw new Error('fetcher parameter is required...');
    }
    this.fetcher = fetcher;  // Fetcher handles proxy internally
    this.logger = logger;
  }
}
```

**Benefit:** Testability - Mock fetcher for unit tests without hitting real API

#### 2. Facade Pattern âœ“ APPLIED

**Where Applied:** `sdk.mjs:1-492` (entire file)

**Implementation:** SDK provides simplified interface over raw FigmaApiClient methods:

```javascript
// Low-level (FigmaApiClient)
const response = await fetcher.request('/v2/webhooks', {
  method: 'POST',
  body: {
    team_id: '123',
    event_type: 'FILE_UPDATE',
    endpoint: 'https://example.com/webhook',
    passcode: 'secret',
    status: 'ACTIVE'
  }
});

// High-level (FigmaWebhooksSDK)
const webhook = await sdk.createTeamWebhook({
  teamId: '123',
  eventType: 'FILE_UPDATE',
  endpoint: 'https://example.com/webhook',
  passcode: 'secret',
  active: true
});
```

**Benefit:** Ergonomic API with sensible defaults and error handling

#### 3. Builder Pattern âœ“ APPLIED

**Where Applied:** `sdk.mjs:60-136` (webhook creation methods)

**Implementation:** Chainable configuration with defaults:

```javascript
async createFileWebhook({ fileKey, endpoint, passcode, description, active = true }) {
  return this.fetcher.createWebhook({
    eventType: 'FILE_UPDATE',          // Default event type
    context: 'file',                   // Auto-set context
    contextId: fileKey,                // Map parameter
    endpoint,
    passcode,
    status: active ? 'ACTIVE' : 'PAUSED',  // Boolean to status enum
    description
  });
}
```

**Benefit:** Simple parameter API that maps to complex API requirements

#### 4. Decorator Pattern âœ“ APPLIED

**Where Applied:** `sdk.mjs:143-152, 197-207` (enhanced error handling)

**Implementation:** Wraps fetcher methods with additional logic:

```javascript
async getWebhook(webhookId) {
  try {
    return await this.fetcher.getWebhook(webhookId);
  } catch (error) {
    if (error.meta?.status === 404) {
      return null;  // Convert 404 error to null
    }
    throw error;  // Re-throw other errors
  }
}

async deleteWebhook(webhookId) {
  try {
    await this.fetcher.deleteWebhook(webhookId);
    return true;  // Success indicator
  } catch (error) {
    if (error.meta?.status === 404) {
      return false;  // Already deleted
    }
    throw error;
  }
}
```

**Benefit:** Consistent null/boolean returns instead of throwing on expected errors

#### 5. Iterator Pattern âœ“ APPLIED

**Where Applied:** `sdk.mjs:172-180` (pagination)

**Implementation:** Async iteration over paginated results:

```javascript
async listAllWebhooks(planApiId) {
  const webhooks = [];

  for await (const batch of this.fetcher.paginateWebhooks(planApiId)) {
    webhooks.push(...batch);
  }

  return webhooks;
}
```

**Benefit:** Automatic pagination handling for large webhook collections

### Data Flow Diagrams

#### Webhook Creation Flow

```
User/CLI
    â†“
    â”‚ figma-webhooks create --event FILE_UPDATE --context file --context-id abc123
    â†“
CLI.create command (cli.mjs:143-178)
    â†“
    â”‚ Parse arguments, validate required fields
    â†“
getSDK(options) (cli.mjs:25-40)
    â†“
    â”‚ âŒ BROKEN: Should create FigmaApiClient first
    â”‚ new FigmaApiClient({ apiToken: token })
    â†“
    â”‚ âŒ BROKEN: Currently passes { apiToken, baseUrl } directly to SDK
new FigmaWebhooksSDK({ apiToken, baseUrl })  // Should be { fetcher }
    â†“
SDK.createFileWebhook() (sdk.mjs:60-76) âš ï¸  BROKEN SDK INIT
    â†“
    â”‚ Map parameters: fileKey â†’ contextId, active â†’ status
    â”‚ Set defaults: eventType = 'FILE_UPDATE', context = 'file'
    â†“
this.fetcher.createWebhook({ ... }) (via @figma-api/fetch)
    â†“
FigmaApiClient.request() (@figma-api/fetch)
    â†“
    â”‚ [Rate Limiter] - Check token bucket (60 req/min)
    â”‚ [Request Cache] - Check LRU cache (miss for POST)
    â”‚ [Interceptors] - Add authentication headers
    â†“
HTTP POST https://api.figma.com/v2/webhooks
    â†“
    â”‚ [Retry Handler] - Retry on 5xx/network errors
    â”‚ [Error Handler] - Convert HTTP errors to custom exceptions
    â†“
Figma API Response
    â†“
    â”‚ Status: 200 OK
    â”‚ Body: { id: 'wh_123', event_type: 'FILE_UPDATE', ... }
    â†“
SDK returns webhook object
    â†“
CLI.formatOutput() (cli.mjs:43-57)
    â†“
    â”‚ Format: {id} | {event_type} | {status} | {context}:{context_id} | {endpoint}
    â†“
Console output: wh_123 | FILE_UPDATE | ACTIVE | file:abc123 | https://...
```

#### Health Check Flow

```
User Request
    â†“
    â”‚ figma-webhooks health wh_123
    â†“
CLI.health command (cli.mjs:335-379)
    â†“
SDK.checkWebhookHealth(webhookId) (sdk.mjs:244-285)
    â†“
SDK.getWebhookHistory(webhookId) (sdk.mjs:234-237)
    â†“
this.fetcher.getWebhookRequests(webhookId)
    â†“
    â”‚ [Rate Limiter] - Check quota
    â”‚ [Request Cache] - Check cache (5 min TTL)
    â†“
HTTP GET /v2/webhooks/wh_123/requests
    â†“
Figma API Response
    â†“
    â”‚ Body: { requests: [ ... ] }
    â†“
Health Analysis (sdk.mjs:246-285)
    â†“
    â”‚ Filter successful requests (status < 400)
    â”‚ Calculate: successRate = successful / total
    â”‚ Determine status:
    â”‚   - successRate === 0 â†’ 'failing'
    â”‚   - successRate < 0.8 â†’ 'degraded'
    â”‚   - successRate >= 0.8 â†’ 'healthy'
    â”‚   - no requests â†’ 'unknown'
    â†“
Return health object
    â†“
    â”‚ {
    â”‚   status: 'healthy',
    â”‚   message: 'Webhook is healthy (95% success rate)',
    â”‚   successRate: 0.95,
    â”‚   lastDelivery: '2025-11-02T10:30:00Z',
    â”‚   totalRequests: 100,
    â”‚   successfulRequests: 95,
    â”‚   failedRequests: 5
    â”‚ }
    â†“
CLI.formatOutput() (cli.mjs:346-371)
    â†“
    â”‚ Color-code status (green/yellow/red/gray)
    â”‚ Format success rate as percentage
    â”‚ Display request counts
    â†“
Console output with color formatting
```

#### Endpoint Testing Flow (VIOLATION)

```
User Request
    â†“
    â”‚ figma-webhooks test-endpoint https://example.com/webhook
    â†“
CLI.test-endpoint command (cli.mjs:384-411)
    â†“
SDK.testWebhookEndpoint(endpoint) (sdk.mjs:419-453)
    â†“
    â”‚ âŒ ARCHITECTURAL VIOLATION STARTS HERE
    â†“
Direct undici fetch() (sdk.mjs:439)
    â†“
    â”‚ import { fetch, ProxyAgent } from 'undici';  // Line 6
    â”‚
    â”‚ const fetchOptions = {
    â”‚   method: 'POST',
    â”‚   headers: { 'Content-Type': 'application/json', 'X-Figma-Event': 'PING' },
    â”‚   body: JSON.stringify({ event_type: 'PING', ... })
    â”‚ };
    â”‚
    â”‚ if (this.proxyAgent) {
    â”‚   fetchOptions.dispatcher = this.proxyAgent;  // Uses SDK's own ProxyAgent
    â”‚ }
    â”‚
    â”‚ const response = await fetch(endpoint, fetchOptions);  // Bypasses @figma-api/fetch
    â†“
    â”‚ [BYPASSED] - No rate limiting
    â”‚ [BYPASSED] - No request caching
    â”‚ [BYPASSED] - No retry logic
    â”‚ [BYPASSED] - No interceptors
    â”‚ [BYPASSED] - No centralized error handling
    â†“
HTTP POST https://example.com/webhook
    â†“
User's Webhook Endpoint
    â†“
Response
    â†“
Return test result
    â†“
    â”‚ {
    â”‚   reachable: true,
    â”‚   status: 200,
    â”‚   statusText: 'OK',
    â”‚   headers: { ... }
    â”‚ }
    â†“
Console output
```

**Problem:** The endpoint testing flow bypasses all @figma-api/fetch benefits. Should use:

```javascript
async testWebhookEndpoint(endpoint) {
  const testPayload = {
    event_type: 'PING',
    timestamp: new Date().toISOString(),
    webhook_id: 'test'
  };

  try {
    // Use fetcher with custom fetch adapter for non-Figma endpoints
    const response = await this.fetcher.fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Figma-Event': 'PING'
      },
      body: JSON.stringify(testPayload)
    });

    return {
      reachable: true,
      status: response.status,
      statusText: response.statusText,
      headers: Object.fromEntries(response.headers.entries())
    };
  } catch (error) {
    return {
      reachable: false,
      error: error.message
    };
  }
}
```

### Cross-Cutting Concerns

#### 1. Error Handling âŒ BROKEN

**Current State:** Error classes exported from deleted `client.mjs`

**Intended Hierarchy:**
```
Error
â””â”€â”€ WebhookError
    â”œâ”€â”€ WebhookAuthError (401, 403)
    â”œâ”€â”€ WebhookValidationError (400)
    â””â”€â”€ WebhookRateLimitError (429)
```

**Should delegate to @figma-api/fetch errors:**
```
FigmaApiError (@figma-api/fetch)
â”œâ”€â”€ NetworkError
â”œâ”€â”€ RateLimitError
â”œâ”€â”€ AuthenticationError
â””â”€â”€ ValidationError
```

**Recommendation:** Remove custom error classes and use @figma-api/fetch errors directly

#### 2. Logging âœ“ PARTIAL

**SDK Layer (sdk.mjs:34, 44):**
```javascript
constructor({ fetcher, logger = console } = {}) {
  this.logger = logger;
  this.logger.debug('Proxy configured: ' + finalProxyUrl);  // Only logging
}
```

**Problem:** Only logs proxy configuration, no other operations

**Recommendation:** Add logging for all major operations:
```javascript
async createFileWebhook({ fileKey, endpoint, ... }) {
  this.logger.debug(`Creating file webhook for ${fileKey}`);
  const webhook = await this.fetcher.createWebhook({ ... });
  this.logger.info(`Created webhook ${webhook.id}`);
  return webhook;
}
```

#### 3. Rate Limiting âœ“ DELEGATED

**Implementation:** Handled by `@figma-api/fetch` (FigmaApiClient)
- Token bucket algorithm
- Default: 60 requests/minute, 10 burst
- Automatic retry with exponential backoff

**SDK doesn't implement own rate limiting** âœ“ Correct

#### 4. Caching âœ“ DELEGATED

**Implementation:** Handled by `@figma-api/fetch` (RequestCache)
- LRU cache with 100 item limit
- 5 minute TTL
- Cache key: `${method}:${url}:${hash(params)}`

**SDK doesn't implement own caching** âœ“ Correct

#### 5. Authentication âœ“ DELEGATED

**Implementation:** Handled by `@figma-api/fetch` (FigmaApiClient)
- API token passed to FigmaApiClient constructor
- Automatically adds `X-Figma-Token` header to all requests

**SDK doesn't handle authentication** âœ“ Correct

#### 6. Proxy Support âš ï¸ DUPLICATE

**Problem:** Both @figma-api/fetch AND sdk.mjs implement proxy support

**@figma-api/fetch implementation:**
```javascript
// Centralized in HTTP client
const fetcher = new FigmaApiClient({
  apiToken: token,
  proxyUrl: process.env.HTTP_PROXY,
  proxyToken: process.env.HTTP_PROXY_TOKEN
});
```

**sdk.mjs duplicate implementation (lines 36-45):**
```javascript
// âŒ Redundant proxy handling
this.proxyAgent = new ProxyAgent({
  uri: finalProxyUrl,
  token: finalProxyToken
});
```

**Recommendation:** Remove proxy handling from SDK, let @figma-api/fetch manage it

### Dependencies

**Peer Dependencies (Required):**
- `@figma-api/fetch@file:../figma-fetch` - Centralized HTTP client âœ“

**Runtime Dependencies:**
- `chalk@^5.3.0` - Terminal colors (CLI) âœ“
- `commander@^12.0.0` - CLI framework âœ“
- `ora@^8.0.1` - Spinner animations (CLI) âœ“
- `undici@^6.21.0` - âŒ **SHOULD BE REMOVED** (architectural violation)

**Dev Dependencies:**
- `@figma-api/fetch@file:../figma-fetch` - For development/testing âœ“
- `@jest/globals@^29.7.0` - Jest testing types âœ“
- `eslint@^8.57.0` - Linting âœ“
- `fastify@^5.6.1` - Health check server âœ“
- `jest@^29.7.0` - Testing framework âœ“
- `prettier@^3.2.5` - Code formatting âœ“

**External Services:**
- Figma Webhooks API v2 (`https://api.figma.com/v2/webhooks`)

### API Scopes

**Required Figma API Scopes:**

All webhook operations require one or more of:
- `webhooks:write` - Create, update, delete webhooks
- `webhooks:read` - List and retrieve webhook details
- `file_comments:read` - Required for file-level webhooks
- `files:read` - Required for file-level webhooks

**Scope-to-Operation Mapping:**

| Operation | Required Scopes |
|-----------|----------------|
| createWebhook | `webhooks:write` |
| getWebhook | `webhooks:read` |
| listWebhooks | `webhooks:read` |
| updateWebhook | `webhooks:write` |
| deleteWebhook | `webhooks:write` |
| pauseWebhook | `webhooks:write` |
| activateWebhook | `webhooks:write` |
| getWebhookRequests | `webhooks:read` |

### Performance Characteristics

**Rate Limiting (via @figma-api/fetch):**
- Default: 60 requests/minute
- Burst capacity: 10 requests
- Automatic retry with exponential backoff (3 retries)

**Caching (via @figma-api/fetch):**
- LRU cache with 100 item limit
- 5 minute TTL
- Enabled for GET requests only
- Cache key: `${method}:${url}:${hash(params)}`

**Bulk Operations:**
- `createBulkWebhooks()` - Sequential (no parallelization)
- `deleteBulkWebhooks()` - Sequential
- `pauseBulkWebhooks()` - Sequential

**Recommendation:** Add concurrency control for bulk operations:
```javascript
async createBulkWebhooks(contextIds, webhookConfig) {
  const results = { created: [], errors: [] };

  // Process in batches of 5 concurrent requests
  for (let i = 0; i < contextIds.length; i += 5) {
    const batch = contextIds.slice(i, i + 5);
    const promises = batch.map(contextId =>
      this.fetcher.createWebhook({ ...webhookConfig, contextId })
        .then(webhook => results.created.push(webhook))
        .catch(error => results.errors.push({ contextId, error: error.message }))
    );
    await Promise.all(promises);
  }

  return results;
}
```

---

## Summary

### Module Status: âŒ NOT OPERATIONALLY READY

**Critical Blockers:**
1. âŒ **Runtime failure** - `index.mjs` imports from deleted `client.mjs`
2. âŒ **Runtime failure** - `health-check-server.mjs` missing `FigmaApiClient` import
3. âŒ **Architectural violation** - `sdk.mjs` imports and uses undici directly
4. âŒ **Zero test coverage** - All test files deleted, no validation

### Strengths (Intended Design)

- âœ“ **Comprehensive SDK** - 30+ methods covering all webhook operations
- âœ“ **Full-featured CLI** - 15 commands with rich formatting and error handling
- âœ“ **Dependency injection** - SDK accepts fetcher parameter (95% compliance)
- âœ“ **Health monitoring** - Success rate tracking and delivery analysis
- âœ“ **Bulk operations** - Create, pause, delete multiple webhooks
- âœ“ **Webhook discovery** - Search by endpoint, event type, status
- âœ“ **Signature verification** - Security validation for webhook payloads
- âœ“ **Health check server** - Fastify-based monitoring endpoints
- âœ“ **ES modules** - Modern module system with proper exports

### Known Risks

**High Priority:**
- âš ï¸ **Module non-functional** - Cannot be imported or used in current state
- âš ï¸ **No test coverage** - Cannot verify fixes or prevent regressions
- âš ï¸ **Architectural inconsistency** - Mixed use of @figma-api/fetch and undici
- âš ï¸ **CLI broken** - getSDK() doesn't create proper fetcher instance

**Medium Priority:**
- âš ï¸ **Duplicate proxy handling** - Both SDK and @figma-api/fetch manage proxies
- âš ï¸ **No error classes** - Missing WebhookError, WebhookAuthError, etc.
- âš ï¸ **Sequential bulk operations** - No concurrency control for performance
- âš ï¸ **Minimal logging** - Only logs proxy configuration

**Low Priority:**
- âš ï¸ **No version history** - No changelog or version documentation
- âš ï¸ **No troubleshooting guide** - Missing common issues section
- âš ï¸ **No performance benchmarks** - No timing data for operations

### Metrics

**Code Metrics:**
- **Total source lines:** 1,353
- **SDK lines:** 492 (36.3%)
- **CLI lines:** 537 (39.7%)
- **Health check lines:** 286 (21.1%)
- **Test lines:** 0 (0%) âŒ
- **Test-to-source ratio:** 0:1 âŒ

**API Surface:**
- **SDK methods:** 30+ methods
- **CLI commands:** 15 commands
- **Health check endpoints:** 8 endpoints
- **Exported classes:** 1 (FigmaWebhooksSDK)
- **Exported errors:** 4 (all broken) âŒ

**Dependencies:**
- **Peer dependencies:** 1 (@figma-api/fetch) âœ“
- **Runtime dependencies:** 4 (3 valid + 1 violation)
- **Dev dependencies:** 6 âœ“
- **Architectural violations:** 1 (direct undici import) âŒ

**Coverage:**
- **Statement coverage:** 0% âŒ
- **Branch coverage:** 0% âŒ
- **Function coverage:** 0% âŒ
- **Line coverage:** 0% âŒ

### Version Requirements

**Runtime:**
- **Node:** >=20.0.0
- **NPM:** >=9.0.0

**Package Manager:**
- ES modules (`"type": "module"`)
- Experimental VM modules for Jest

### Integration Complexity

**High** - Module requires significant fixes before integration:
1. Fix broken imports (2 locations)
2. Remove undici dependency (1 violation)
3. Create test suite (0 â†’ 500+ lines)
4. Fix CLI SDK initialization (1 location)
5. Remove duplicate proxy handling (1 location)
6. Optionally recreate error classes (4 classes)

### Operational Readiness Indicators

- âŒ **Functional:** Module fails at runtime
- âŒ **Tested:** 0% test coverage
- âœ“ **Documented:** README.md, EXAMPLES.md, INSTRUCTIONS.md exist
- âŒ **Health check:** Server crashes on startup (missing import)
- âœ“ **Monitoring:** Health check endpoints defined (but broken)
- âœ“ **Error tracking:** Error classes designed (but exports broken)
- âŒ **Deployment ready:** Cannot deploy in current state

**Operational Readiness Score:** **1/7 (14%)** âŒ

---

## Fix Recommendations

### Priority 1: Critical Runtime Fixes (Required for Module to Function)

#### Fix 1.1: Remove Broken Error Exports

**File:** `index.mjs:7-12`

**Current (Broken):**
```javascript
export {
  WebhookError,
  WebhookAuthError,
  WebhookValidationError,
  WebhookRateLimitError
} from './client.mjs';  // âŒ File does not exist
```

**Fix Option A (Quick):** Remove error exports entirely
```javascript
// Delete lines 7-12
```

**Fix Option B (Recommended):** Recreate error classes

1. Create `errors.mjs`:
```javascript
export class WebhookError extends Error {
  constructor(message, { code, meta } = {}) {
    super(message);
    this.name = 'WebhookError';
    this.code = code;
    this.meta = meta;
  }
}

export class WebhookAuthError extends WebhookError {
  constructor(message, options) {
    super(message, options);
    this.name = 'WebhookAuthError';
  }
}

export class WebhookValidationError extends WebhookError {
  constructor(message, options) {
    super(message, options);
    this.name = 'WebhookValidationError';
  }
}

export class WebhookRateLimitError extends WebhookError {
  constructor(message, options) {
    super(message, options);
    this.name = 'WebhookRateLimitError';
  }
}
```

2. Update `index.mjs:12`:
```javascript
export {
  WebhookError,
  WebhookAuthError,
  WebhookValidationError,
  WebhookRateLimitError
} from './errors.mjs';  // âœ“ Fixed path
```

#### Fix 1.2: Add Missing FigmaApiClient Import

**File:** `health-check-server.mjs:1`

**Add after line 7:**
```javascript
import Fastify from 'fastify';
import FigmaWebhooksSDK from './index.mjs';
import { FigmaApiClient } from '@figma-api/fetch';  // âœ“ Add this line
```

**Update line 70:**
```javascript
// Before (broken):
const sdk = new FigmaWebhooksSDK({ fetcher: new FigmaApiClient({ apiToken: FIGMA_TOKEN }) });

// After (fixed):
const fetcher = new FigmaApiClient({ apiToken: FIGMA_TOKEN });
const sdk = new FigmaWebhooksSDK({ fetcher });
```

**Repeat for all SDK instantiations:** Lines 99, 135, 167, 196, 225

**Update line 254 (verify endpoint):**
```javascript
// Before (broken):
const sdk = new FigmaWebhooksSDK({ token: FIGMA_TOKEN || 'dummy' });

// After (fixed):
const fetcher = new FigmaApiClient({ apiToken: FIGMA_TOKEN || 'dummy' });
const sdk = new FigmaWebhooksSDK({ fetcher });
```

#### Fix 1.3: Fix CLI SDK Initialization

**File:** `cli.mjs:25-40`

**Current (Broken):**
```javascript
function getSDK(options) {
  const token = options.token || process.env.FIGMA_TOKEN;
  if (!token) {
    console.error(chalk.red('Error: Figma API token is required'));
    process.exit(1);
  }

  return new FigmaWebhooksSDK({
    apiToken: token,      // âŒ Wrong parameter
    baseUrl: options.baseUrl,  // âŒ Wrong parameter
    logger: options.verbose ? console : { debug: () => {}, log: () => {}, error: console.error }
  });
}
```

**Fixed:**
```javascript
import { FigmaApiClient } from '@figma-api/fetch';  // Add import at top

function getSDK(options) {
  const token = options.token || process.env.FIGMA_TOKEN;
  if (!token) {
    console.error(chalk.red('Error: Figma API token is required'));
    process.exit(1);
  }

  // Create fetcher first
  const fetcher = new FigmaApiClient({
    apiToken: token,
    baseUrl: options.baseUrl || 'https://api.figma.com'
  });

  // Pass fetcher to SDK
  return new FigmaWebhooksSDK({
    fetcher,  // âœ“ Correct parameter
    logger: options.verbose ? console : { debug: () => {}, log: () => {}, error: console.error }
  });
}
```

**Also fix line 159 (create command):**
```javascript
// Before (broken):
const webhook = await sdk.client.createWebhook({ ... });

// After (fixed):
const webhook = await sdk.fetcher.createWebhook({ ... });
```

### Priority 2: Architectural Compliance (Required for REQ003.md Standards)

#### Fix 2.1: Remove Direct Undici Import from SDK

**File:** `sdk.mjs:6`

**Remove import:**
```javascript
// Delete this line:
import { fetch, ProxyAgent } from 'undici';  // âŒ Remove
```

#### Fix 2.2: Remove Proxy Handling from SDK Constructor

**File:** `sdk.mjs:28-46`

**Current (with proxy handling):**
```javascript
constructor({ fetcher, logger = console, proxyUrl, proxyToken } = {}) {
  if (!fetcher) {
    throw new Error('fetcher parameter is required...');
  }
  this.fetcher = fetcher;
  this.logger = logger;

  // âŒ Remove proxy handling
  const finalProxyUrl = proxyUrl || process.env.HTTP_PROXY;
  const finalProxyToken = proxyToken || process.env.HTTP_PROXY_TOKEN;
  this.proxyAgent = null;
  if (finalProxyUrl) {
    this.proxyAgent = finalProxyToken
      ? new ProxyAgent({ uri: finalProxyUrl, token: finalProxyToken })
      : new ProxyAgent(finalProxyUrl);
    this.logger.debug(`Proxy configured: ${finalProxyUrl}`);
  }
}
```

**Fixed (no proxy handling):**
```javascript
constructor({ fetcher, logger = console } = {}) {
  if (!fetcher) {
    throw new Error('fetcher parameter is required. Please create and pass a FigmaApiClient instance.');
  }
  this.fetcher = fetcher;
  this.logger = logger;
}
```

#### Fix 2.3: Rewrite testWebhookEndpoint() to Use Fetcher

**File:** `sdk.mjs:419-453`

**Current (using undici directly):**
```javascript
async testWebhookEndpoint(endpoint) {
  try {
    const fetchOptions = {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Figma-Event': 'PING'
      },
      body: JSON.stringify({ ... })
    };

    if (this.proxyAgent) {
      fetchOptions.dispatcher = this.proxyAgent;  // âŒ Uses undici ProxyAgent
    }

    const response = await fetch(endpoint, fetchOptions);  // âŒ Direct fetch

    return {
      reachable: true,
      status: response.status,
      statusText: response.statusText,
      headers: Object.fromEntries(response.headers.entries())
    };
  } catch (error) {
    return { reachable: false, error: error.message };
  }
}
```

**Fixed (using fetcher):**
```javascript
async testWebhookEndpoint(endpoint) {
  const testPayload = {
    event_type: 'PING',
    timestamp: new Date().toISOString(),
    webhook_id: 'test'
  };

  try {
    // Use fetcher's raw fetch capability for non-Figma endpoints
    const response = await this.fetcher.fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Figma-Event': 'PING'
      },
      body: JSON.stringify(testPayload)
    });

    return {
      reachable: true,
      status: response.status,
      statusText: response.statusText,
      headers: Object.fromEntries(response.headers.entries())
    };
  } catch (error) {
    return {
      reachable: false,
      error: error.message
    };
  }
}
```

**Note:** This requires `@figma-api/fetch` to expose a raw `fetch()` method for non-Figma API endpoints. If not available, consider:
- Adding `fetch()` method to FigmaApiClient
- Or keeping undici import but documenting as exception
- Or removing endpoint testing feature

#### Fix 2.4: Remove Undici from package.json

**File:** `package.json:54-59`

**Current:**
```json
{
  "dependencies": {
    "chalk": "^5.3.0",
    "commander": "^12.0.0",
    "ora": "^8.0.1",
    "undici": "^6.21.0"  // âŒ Remove this line
  }
}
```

**Fixed:**
```json
{
  "dependencies": {
    "chalk": "^5.3.0",
    "commander": "^12.0.0",
    "ora": "^8.0.1"
  }
}
```

**Run after fix:**
```bash
npm install  # Update package-lock.json
```

### Priority 3: Test Coverage (Required for Operational Readiness)

#### Fix 3.1: Create SDK Test Suite

**File:** `tests/unit/sdk.test.mjs` (new file)

**Minimum test cases:**
```javascript
import { describe, it, expect, jest, beforeEach } from '@jest/globals';
import { FigmaWebhooksSDK } from '../../sdk.mjs';

describe('FigmaWebhooksSDK', () => {
  let mockFetcher;
  let sdk;

  beforeEach(() => {
    mockFetcher = {
      createWebhook: jest.fn(),
      getWebhook: jest.fn(),
      getWebhooks: jest.fn(),
      updateWebhook: jest.fn(),
      deleteWebhook: jest.fn(),
      pauseWebhook: jest.fn(),
      activateWebhook: jest.fn(),
      getWebhookRequests: jest.fn(),
      paginateWebhooks: jest.fn(),
      verifyWebhookSignature: jest.fn(),
      eventTypes: ['FILE_UPDATE', 'FILE_DELETE'],
      contextTypes: ['team', 'project', 'file']
    };

    sdk = new FigmaWebhooksSDK({ fetcher: mockFetcher });
  });

  describe('constructor', () => {
    it('should require fetcher parameter', () => {
      expect(() => new FigmaWebhooksSDK({})).toThrow('fetcher parameter is required');
    });

    it('should store fetcher instance', () => {
      expect(sdk.fetcher).toBe(mockFetcher);
    });
  });

  describe('createFileWebhook', () => {
    it('should create file webhook with correct parameters', async () => {
      mockFetcher.createWebhook.mockResolvedValue({ id: 'wh_123' });

      const webhook = await sdk.createFileWebhook({
        fileKey: 'abc123',
        endpoint: 'https://example.com/webhook',
        passcode: 'secret'
      });

      expect(webhook.id).toBe('wh_123');
      expect(mockFetcher.createWebhook).toHaveBeenCalledWith({
        eventType: 'FILE_UPDATE',
        context: 'file',
        contextId: 'abc123',
        endpoint: 'https://example.com/webhook',
        passcode: 'secret',
        status: 'ACTIVE',
        description: undefined
      });
    });
  });

  // Add tests for all 30+ SDK methods...
});
```

**Estimated:** 500+ lines of test code needed for full coverage

#### Fix 3.2: Create CLI Test Suite

**File:** `tests/unit/cli.test.mjs` (new file)

**Test command parsing, argument validation, output formatting**

#### Fix 3.3: Create Health Check Server Test Suite

**File:** `tests/unit/health-check-server.test.mjs` (new file)

**Test all 8 endpoints with/without FIGMA_TOKEN**

### Priority 4: Enhancements (Optional)

#### Enhancement 4.1: Add Comprehensive Logging

**File:** `sdk.mjs` (multiple locations)

**Add logging for major operations:**
```javascript
async createFileWebhook({ fileKey, endpoint, ... }) {
  this.logger.debug(`Creating file webhook for ${fileKey}`);
  const webhook = await this.fetcher.createWebhook({ ... });
  this.logger.info(`Created webhook ${webhook.id} for file ${fileKey}`);
  return webhook;
}

async deleteWebhook(webhookId) {
  this.logger.debug(`Deleting webhook ${webhookId}`);
  try {
    await this.fetcher.deleteWebhook(webhookId);
    this.logger.info(`Deleted webhook ${webhookId}`);
    return true;
  } catch (error) {
    if (error.meta?.status === 404) {
      this.logger.warn(`Webhook ${webhookId} already deleted`);
      return false;
    }
    this.logger.error(`Failed to delete webhook ${webhookId}:`, error);
    throw error;
  }
}
```

#### Enhancement 4.2: Add Concurrency to Bulk Operations

**File:** `sdk.mjs:299-322, 329-348, 356-376`

**Replace sequential processing with batched concurrency:**
```javascript
async createBulkWebhooks(contextIds, webhookConfig, { concurrency = 5 } = {}) {
  const results = { created: [], errors: [] };

  for (let i = 0; i < contextIds.length; i += concurrency) {
    const batch = contextIds.slice(i, i + concurrency);
    const promises = batch.map(contextId =>
      this.fetcher.createWebhook({ ...webhookConfig, contextId })
        .then(webhook => results.created.push(webhook))
        .catch(error => results.errors.push({ contextId, error: error.message, code: error.code }))
    );
    await Promise.all(promises);
  }

  return results;
}
```

### Validation Checklist

After applying fixes, verify:

- [ ] `npm install` completes without errors
- [ ] `node index.mjs` doesn't throw import errors
- [ ] `node health-check-server.mjs` starts successfully
- [ ] Health check responds: `curl http://localhost:3009/`
- [ ] CLI shows help: `./cli.mjs --help`
- [ ] No direct undici imports: `grep -r "from 'undici'" *.mjs`
- [ ] All fetcher usage: `grep -r "this.fetcher" sdk.mjs` (should find 30+ matches)
- [ ] Tests exist: `find tests -name "*.test.mjs" | wc -l` (should be >= 3)
- [ ] Tests pass: `npm test`
- [ ] Coverage acceptable: `npm run test:coverage` (target: >80%)

### Implementation Order

1. **Fix 1.1** - Remove broken error exports (5 minutes)
2. **Fix 1.2** - Add FigmaApiClient import to health-check-server.mjs (10 minutes)
3. **Fix 1.3** - Fix CLI getSDK() function (10 minutes)
4. **Verify** - Test module loads and health check starts (5 minutes)
5. **Fix 2.1-2.4** - Remove undici dependency and proxy handling (20 minutes)
6. **Fix 2.3** - Rewrite testWebhookEndpoint() (15 minutes if fetcher.fetch() exists)
7. **Verify** - Test all architectural violations resolved (10 minutes)
8. **Fix 3.1-3.3** - Create test suites (4-8 hours)
9. **Verify** - Run full test suite and coverage report (10 minutes)
10. **Enhancement 4.1-4.2** - Add logging and concurrency (1-2 hours, optional)

**Total Estimated Time:** 6-10 hours (including testing)

---

**Documentation Generated:** 2025-11-02
**Module Status:** âŒ BROKEN - Requires immediate fixes
**Compliance Score:** 14% (1/7 operational readiness indicators)
**Next Steps:** Apply Priority 1 fixes to restore basic functionality
