# Figma Components Module - Technical Documentation

**Module:** figma-components-api
**Version:** 1.0.0
**Documentation Standard:** REQ003.md
**Generated:** 2025-11-02
**Compliance Status:** âœ… 100% Compliant

---

## Table of Contents

1. [Overview](#1-overview)
2. [Source Code Structure](#2-source-code-structure)
3. [Test Coverage](#3-test-coverage)
4. [Health Check Server](#4-health-check-server)
5. [Main Entry Point](#5-main-entry-point)
6. [Architecture](#6-architecture)
7. [Summary](#7-summary)
8. [Compliance Verification](#8-compliance-verification)
9. [Fix History](#9-fix-history)

---

## 1. Overview

The Figma Components module provides comprehensive SDK and CLI access to Figma's Components, Component Sets, and Styles API. This module implements the centralized HTTP client pattern with full dependency injection.

**Key Capabilities:**
- Team and file-level component operations with pagination support
- Component sets and styles management
- Batch operations for multiple resources
- Library content aggregation and analytics
- Search and filtering capabilities
- CLI interface for command-line operations

**Primary Use Cases:**
- Design system automation and management
- Component inventory and auditing
- Library analytics and reporting
- Integration with CI/CD pipelines
- Automated design token extraction

**Integration Points:**
- Requires `@figma-api/fetch` as peer dependency for HTTP client
- Exports service, SDK, CLI, and exception classes
- Compatible with ES modules (Node.js >= 20.0.0)

---

## 2. Source Code Structure

### **index.mjs** (34 lines)

**Location:** `index.mjs:1`

**Purpose:** Main entry point exposing all public interfaces for the library

**Key Components:**

##### 1. Core Exports (lines 7-7)
- `FigmaComponentsService` - Service layer class
  - **Line reference:** `index.mjs:7`

##### 2. Interface Exports (lines 10-10)
- `FigmaComponentsSDK` - SDK facade class
  - **Line reference:** `index.mjs:10`

##### 3. Exception Exports (lines 13-32)
- `FigmaApiError` - Base error class
- `RateLimitError` - Rate limit errors
- `AuthenticationError` - Auth failures
- `AuthorizationError` - Permission errors
- `TeamNotFoundError` - Team resource errors
- `FileNotFoundError` - File resource errors
- `ComponentNotFoundError` - Component resource errors
- `ComponentSetNotFoundError` - Component set errors
- `StyleNotFoundError` - Style resource errors
- `ValidationError` - Input validation errors
- `NetworkError` - Network failures
- `HttpError` - HTTP status errors
- `ServerError` - 5xx errors
- `TimeoutError` - Request timeouts
- `PaginationError` - Pagination errors
- `ScopeError` - OAuth scope errors
- `createErrorFromResponse()` - Error factory
- `isRetryableError()` - Retry checker
  - **Line reference:** `index.mjs:13-32`

**Dependencies:**
- `./src/core/service.mjs` - Service layer
- `./src/interfaces/sdk.mjs` - SDK facade
- `./src/core/exceptions.mjs` - Error classes

---

### **src/core/service.mjs** (570 lines)

**Location:** `src/core/service.mjs:1`

**Purpose:** Service layer implementing business logic for all components, component sets, and styles endpoints with HTTP client dependency injection

**Key Components:**

##### 1. Constructor with Dependency Injection (lines 28-34)
- `constructor({ fetcher, logger = console })` - Initializes service with injected dependencies
  - **Parameters:**
    - `fetcher` (FigmaApiClient): HTTP client instance (required)
    - `logger` (Object): Logger instance with debug/info/error methods
  - **Throws:** Error if fetcher not provided
  - **Line reference:** `service.mjs:28`

##### 2. Validation Methods (lines 40-126)
- `_validateTeamId(teamId)` - Validates team ID format (numeric strings)
  - **Line reference:** `service.mjs:40`
- `_validateFileKey(fileKey)` - Validates file key format (alphanumeric with dashes)
  - **Line reference:** `service.mjs:55`
- `_validateComponentKey(key)` - Validates component key format (alphanumeric with colons/dashes)
  - **Line reference:** `service.mjs:70`
- `_validatePaginationParams(params)` - Validates pagination options
  - **Line reference:** `service.mjs:85`
- `_validateScopes(endpoint, scopes)` - Validates OAuth scopes for endpoints
  - **Line reference:** `service.mjs:111`

##### 3. Components API Methods (lines 144-193)
- `getTeamComponents(teamId, options = {})` - Fetches paginated team components
  - **Parameters:**
    - `teamId` (String): Team ID to list components from
    - `options.pageSize` (Number): Items per page (max 1000)
    - `options.after` (Number): Pagination cursor
    - `options.before` (Number): Pagination cursor
  - **Returns:** Paginated list of components
  - **Required scopes:** `team_library_content:read`, `files:read`
  - **HTTP calls:** `this.fetcher.get(/v1/teams/${teamId}/components)`
  - **Line reference:** `service.mjs:144`

- `getFileComponents(fileKey)` - Fetches components from a file library
  - **Parameters:**
    - `fileKey` (String): File key to list components from
  - **Returns:** List of components in file
  - **Required scopes:** `library_content:read`, `files:read`
  - **HTTP calls:** `this.fetcher.get(/v1/files/${fileKey}/components)`
  - **Line reference:** `service.mjs:168`

- `getComponent(key)` - Fetches component metadata by key
  - **Parameters:**
    - `key` (String): Unique component identifier
  - **Returns:** Component metadata
  - **Required scopes:** `library_assets:read`, `files:read`
  - **HTTP calls:** `this.fetcher.get(/v1/components/${key})`
  - **Line reference:** `service.mjs:185`

##### 4. Component Sets API Methods (lines 210-258)
- `getTeamComponentSets(teamId, options = {})` - Fetches paginated team component sets
  - **Required scopes:** `team_library_content:read`, `files:read`
  - **HTTP calls:** `this.fetcher.get(/v1/teams/${teamId}/component_sets)`
  - **Line reference:** `service.mjs:210`

- `getFileComponentSets(fileKey)` - Fetches component sets from file
  - **Required scopes:** `library_content:read`, `files:read`
  - **HTTP calls:** `this.fetcher.get(/v1/files/${fileKey}/component_sets)`
  - **Line reference:** `service.mjs:234`

- `getComponentSet(key)` - Fetches component set metadata
  - **Required scopes:** `library_assets:read`, `files:read`
  - **HTTP calls:** `this.fetcher.get(/v1/component_sets/${key})`
  - **Line reference:** `service.mjs:251`

##### 5. Styles API Methods (lines 276-324)
- `getTeamStyles(teamId, options = {})` - Fetches paginated team styles
  - **Required scopes:** `team_library_content:read`, `files:read`
  - **HTTP calls:** `this.fetcher.get(/v1/teams/${teamId}/styles)`
  - **Line reference:** `service.mjs:276`

- `getFileStyles(fileKey)` - Fetches styles from file
  - **Required scopes:** `library_content:read`, `files:read`
  - **HTTP calls:** `this.fetcher.get(/v1/files/${fileKey}/styles)`
  - **Line reference:** `service.mjs:300`

- `getStyle(key)` - Fetches style metadata
  - **Required scopes:** `library_assets:read`, `files:read`
  - **HTTP calls:** `this.fetcher.get(/v1/styles/${key})`
  - **Line reference:** `service.mjs:317`

##### 6. Batch Operations (lines 337-463)
- `batchGetComponents(keys)` - Batch retrieval of multiple components in parallel
  - **Parameters:**
    - `keys` (Array): Component keys to retrieve
  - **Returns:** Object with successful/failed arrays and total count
  - **Line reference:** `service.mjs:337`

- `batchGetComponentSets(keys)` - Batch retrieval of component sets
  - **Line reference:** `service.mjs:382`

- `batchGetStyles(keys)` - Batch retrieval of styles
  - **Line reference:** `service.mjs:427`

##### 7. Convenience Methods (lines 477-552)
- `getTeamLibraryContent(teamId, options = {})` - Fetches complete team library (components, sets, styles)
  - **Line reference:** `service.mjs:477`

- `getFileLibraryContent(fileKey)` - Fetches complete file library
  - **Line reference:** `service.mjs:507`

- `searchTeamComponentsByName(teamId, searchTerm, options = {})` - Client-side name search
  - **Line reference:** `service.mjs:539`

##### 8. Utility Methods (lines 558-568)
- `getStats()` - Retrieves HTTP client statistics
  - **Returns:** HTTP client statistics object
  - **Line reference:** `service.mjs:558`

- `healthCheck()` - Performs service health check
  - **Returns:** Boolean indicating health status
  - **Line reference:** `service.mjs:566`

**Dependencies:**
- `./exceptions.mjs` - Custom error classes

**Error Handling:**
- Throws `ValidationError` for invalid inputs
- Throws `PaginationError` for invalid pagination params
- Propagates errors from HTTP client layer
- Logs warnings for scope mismatches

**Usage Example:**
```javascript
import { FigmaApiClient } from '@figma-api/fetch';
import { FigmaComponentsService } from 'figma-components-api/service';

const fetcher = new FigmaApiClient({ apiToken: process.env.FIGMA_TOKEN });
const service = new FigmaComponentsService({ fetcher });

const components = await service.getTeamComponents('123456');
```

---

### **src/interfaces/sdk.mjs** (474 lines)

**Location:** `src/interfaces/sdk.mjs:1`

**Purpose:** SDK facade providing ergonomic API over core service layer with simplified interface for common use cases

**Key Components:**

##### 1. Constructor (lines 26-32)
- `constructor({ fetcher, logger = console })` - Initializes SDK with service layer
  - **Parameters:**
    - `fetcher` (FigmaApiClient): HTTP client instance (required)
    - `logger` (Object): Logger instance
  - **Line reference:** `sdk.mjs:26`

##### 2. Components Operations (lines 44-105)
- `getTeamComponents(teamId, options = {})` - Delegates to service layer
  - **Line reference:** `sdk.mjs:44`

- `getAllTeamComponents(teamId, maxItems = 1000)` - Automatic pagination handling
  - **Parameters:**
    - `teamId` (String): Team ID
    - `maxItems` (Number): Maximum items to fetch
  - **Returns:** Array of all components
  - **Line reference:** `sdk.mjs:54`

- `getFileComponents(fileKey)` - Fetches file components
  - **Line reference:** `sdk.mjs:84`

- `getComponent(key)` - Fetches single component
  - **Line reference:** `sdk.mjs:93`

- `searchComponents(teamId, searchTerm)` - Searches components by name
  - **Line reference:** `sdk.mjs:103`

##### 3. Component Sets Operations (lines 117-168)
- `getTeamComponentSets(teamId, options = {})` - Fetches team component sets
  - **Line reference:** `sdk.mjs:117`

- `getAllTeamComponentSets(teamId, maxItems = 1000)` - Auto-pagination for sets
  - **Line reference:** `sdk.mjs:127`

- `getFileComponentSets(fileKey)` - Fetches file component sets
  - **Line reference:** `sdk.mjs:157`

- `getComponentSet(key)` - Fetches single component set
  - **Line reference:** `sdk.mjs:166`

##### 4. Styles Operations (lines 180-231)
- `getTeamStyles(teamId, options = {})` - Fetches team styles
  - **Line reference:** `sdk.mjs:180`

- `getAllTeamStyles(teamId, maxItems = 1000)` - Auto-pagination for styles
  - **Line reference:** `sdk.mjs:190`

- `getFileStyles(fileKey)` - Fetches file styles
  - **Line reference:** `sdk.mjs:220`

- `getStyle(key)` - Fetches single style
  - **Line reference:** `sdk.mjs:229`

##### 5. Batch Operations (lines 242-262)
- `batchGetComponents(keys)` - Batch component retrieval
  - **Line reference:** `sdk.mjs:242`

- `batchGetComponentSets(keys)` - Batch component set retrieval
  - **Line reference:** `sdk.mjs:251`

- `batchGetStyles(keys)` - Batch style retrieval
  - **Line reference:** `sdk.mjs:260`

##### 6. Library Content Operations (lines 274-354)
- `getTeamLibrary(teamId, options = {})` - Complete team library
  - **Line reference:** `sdk.mjs:274`

- `getFileLibrary(fileKey)` - Complete file library
  - **Line reference:** `sdk.mjs:283`

- `getTeamLibraryAnalytics(teamId)` - Library analytics with breakdowns
  - **Returns:** Analytics object with counts by type
  - **Line reference:** `sdk.mjs:292`

- `exportTeamLibrary(teamId, options = {})` - Exports library as structured data
  - **Options:**
    - `includeMetadata` (Boolean): Include export metadata
    - `format` (String): Export format (json)
  - **Line reference:** `sdk.mjs:331`

##### 7. Search and Filter Operations (lines 369-399)
- `findComponents(teamId, pattern)` - Pattern-based component search
  - **Options:**
    - `pattern.name` (String): Name pattern (partial match)
    - `pattern.description` (String): Description pattern
    - `pattern.nodeType` (String): Node type filter
  - **Line reference:** `sdk.mjs:369`

- `findStylesByType(teamId, styleType)` - Filter styles by type
  - **Parameters:**
    - `styleType` (String): Style type (FILL, TEXT, EFFECT, GRID)
  - **Line reference:** `sdk.mjs:395`

##### 8. Static Utility Methods (lines 410-456)
- `parseComponentKeyFromUrl(url)` - Extracts component key from Figma URL
  - **Line reference:** `sdk.mjs:410`

- `parseTeamIdFromUrl(url)` - Extracts team ID from Figma URL
  - **Line reference:** `sdk.mjs:423`

- `isValidComponentKey(key)` - Validates component key format
  - **Line reference:** `sdk.mjs:436`

- `isValidTeamId(teamId)` - Validates team ID format
  - **Line reference:** `sdk.mjs:445`

- `isValidFileKey(fileKey)` - Validates file key format
  - **Line reference:** `sdk.mjs:454`

##### 9. SDK Utility Methods (lines 462-472)
- `getStats()` - Retrieves service statistics
  - **Line reference:** `sdk.mjs:462`

- `healthCheck()` - Performs health check
  - **Line reference:** `sdk.mjs:470`

**Dependencies:**
- `../core/service.mjs` - Service layer

**Error Handling:**
- Propagates service layer errors
- Validates parameters before delegation

**Usage Example:**
```javascript
import { FigmaApiClient } from '@figma-api/fetch';
import { FigmaComponentsSDK } from 'figma-components-api';

const fetcher = new FigmaApiClient({ apiToken: process.env.FIGMA_TOKEN });
const sdk = new FigmaComponentsSDK({ fetcher });

// Auto-pagination
const allComponents = await sdk.getAllTeamComponents('123456');

// Analytics
const analytics = await sdk.getTeamLibraryAnalytics('123456');
```

---

### **src/interfaces/cli.mjs** (536 lines)

**Location:** `src/interfaces/cli.mjs:1`

**Purpose:** Command-line interface providing terminal access to components, component sets, and styles operations with proper dependency injection

**Key Components:**

##### 1. Imports and Setup (lines 8-14)
- `Command` from commander - CLI framework
- `chalk` - Terminal styling
- `ora` - Spinner animations
- `FigmaApiClient` from @figma-api/fetch - HTTP client
- `FigmaComponentsSDK` - SDK facade
  - **Line reference:** `cli.mjs:8-12`

##### 2. CLI Configuration (lines 16-24)
- Program name, description, version
- Options: `--api-key`, `--verbose`, `--json`, `--pretty`
  - **Line reference:** `cli.mjs:16`

##### 3. SDK Factory with Dependency Injection (lines 27-42)
- `getSDK(options)` - Creates SDK instance with injected FigmaApiClient
  - **Parameters:**
    - `options.apiKey` (String): API token or env var
  - **Returns:** FigmaComponentsSDK instance
  - **Creates:** FigmaApiClient instance (line 36)
  - **Injects:** fetcher into SDK constructor (line 38)
  - **Line reference:** `cli.mjs:27`

##### 4. Components Commands (lines 54-164)
- `components list-team <team-id>` - Lists team components
  - **Options:** `--page-size`, `--after`, `--before`, `--all`
  - **Line reference:** `cli.mjs:59`

- `components list-file <file-key>` - Lists file components
  - **Line reference:** `cli.mjs:94`

- `components get <key>` - Gets component metadata
  - **Line reference:** `cli.mjs:112`

- `components search <team-id> <search-term>` - Searches components
  - **Line reference:** `cli.mjs:130`

- `components batch-get` - Batch gets components
  - **Options:** `--keys <keys...>`
  - **Line reference:** `cli.mjs:148`

##### 5. Component Sets Commands (lines 170-262)
- `component-sets list-team <team-id>` - Lists team component sets
  - **Line reference:** `cli.mjs:175`

- `component-sets list-file <file-key>` - Lists file component sets
  - **Line reference:** `cli.mjs:210`

- `component-sets get <key>` - Gets component set
  - **Line reference:** `cli.mjs:228`

- `component-sets batch-get` - Batch gets component sets
  - **Line reference:** `cli.mjs:246`

##### 6. Styles Commands (lines 268-373)
- `styles list-team <team-id>` - Lists team styles
  - **Options:** `--type <type>` - Filter by style type
  - **Line reference:** `cli.mjs:273`

- `styles list-file <file-key>` - Lists file styles
  - **Line reference:** `cli.mjs:321`

- `styles get <key>` - Gets style metadata
  - **Line reference:** `cli.mjs:339`

- `styles batch-get` - Batch gets styles
  - **Line reference:** `cli.mjs:357`

##### 7. Library Commands (lines 379-463)
- `library get-team <team-id>` - Gets complete team library
  - **Line reference:** `cli.mjs:384`

- `library get-file <file-key>` - Gets complete file library
  - **Line reference:** `cli.mjs:402`

- `library analytics <team-id>` - Analyzes team library
  - **Line reference:** `cli.mjs:420`

- `library export <team-id>` - Exports library data
  - **Options:** `--no-metadata`, `--format <format>`
  - **Line reference:** `cli.mjs:438`

##### 8. Search Commands (lines 469-497)
- `search components <team-id>` - Finds components by pattern
  - **Options:** `--name`, `--description`, `--node-type`
  - **Line reference:** `cli.mjs:474`

##### 9. Utility Commands (lines 500-531)
- `health` - Checks API connectivity
  - **Line reference:** `cli.mjs:500`

- `stats` - Shows SDK statistics
  - **Line reference:** `cli.mjs:523`

**Dependencies:**
- `commander` - CLI framework
- `chalk` - Terminal styling
- `ora` - Spinners
- `@figma-api/fetch` - HTTP client (injected)
- `./sdk.mjs` - SDK facade

**Error Handling:**
- Validates API token presence
- Shows spinner with success/failure states
- Exits with code 1 on errors

**Usage Example:**
```bash
# With env var
export FIGMA_API_TOKEN=your_token
figma-components components list-team 123456 --all --json

# With flag
figma-components --api-key=your_token library get-team 123456 --pretty
```

---

### **src/core/exceptions.mjs** (330 lines)

**Location:** `src/core/exceptions.mjs:1`

**Purpose:** Custom error classes providing structured error handling with context and metadata

**Key Components:**

##### 1. Base Error Class (lines 9-17)
- `FigmaApiError` - Base class for all Figma API errors
  - **Properties:**
    - `name` (String): Error class name
    - `code` (String): Error code
    - `meta` (Object): Error metadata
    - `timestamp` (String): ISO timestamp
  - **Line reference:** `exceptions.mjs:9`

##### 2. HTTP Error Classes (lines 23-197)
- `RateLimitError` - Rate limit exceeded (429)
  - **Properties:** `retryAfter` (Number)
  - **Line reference:** `exceptions.mjs:23`

- `AuthenticationError` - Invalid API token (401)
  - **Line reference:** `exceptions.mjs:42`

- `AuthorizationError` - Insufficient permissions (403)
  - **Line reference:** `exceptions.mjs:52`

- `TeamNotFoundError` - Team resource not found (404)
  - **Line reference:** `exceptions.mjs:65`

- `FileNotFoundError` - File resource not found (404)
  - **Line reference:** `exceptions.mjs:78`

- `ComponentNotFoundError` - Component not found (404)
  - **Line reference:** `exceptions.mjs:91`

- `ComponentSetNotFoundError` - Component set not found (404)
  - **Line reference:** `exceptions.mjs:104`

- `StyleNotFoundError` - Style not found (404)
  - **Line reference:** `exceptions.mjs:117`

- `ValidationError` - Invalid request parameters (400)
  - **Line reference:** `exceptions.mjs:130`

- `NetworkError` - Network request failures
  - **Line reference:** `exceptions.mjs:144`

- `HttpError` - Generic HTTP errors
  - **Line reference:** `exceptions.mjs:158`

- `ServerError` - Server errors (5xx)
  - **Line reference:** `exceptions.mjs:177`

- `TimeoutError` - Request timeout
  - **Line reference:** `exceptions.mjs:190`

##### 3. Application Error Classes (lines 203-224)
- `PaginationError` - Invalid pagination parameters
  - **Line reference:** `exceptions.mjs:203`

- `ScopeError` - Missing OAuth scopes
  - **Line reference:** `exceptions.mjs:216`

##### 4. Utility Functions (lines 232-310)
- `createErrorFromResponse(response, url, body = null)` - Error factory
  - **Parameters:**
    - `response` (Response): Fetch API response
    - `url` (String): Request URL
    - `body` (Object): Parsed response body
  - **Returns:** Appropriate error instance based on status code
  - **Line reference:** `exceptions.mjs:233`

- `isRetryableError(error)` - Retry checker
  - **Parameters:**
    - `error` (Error): Error to check
  - **Returns:** Boolean indicating if error is retryable
  - **Line reference:** `exceptions.mjs:299`

**Dependencies:**
- None (standalone module)

**Error Handling:**
- All errors extend FigmaApiError base class
- Retryable errors marked with `meta.retryable = true`
- Context preserved in metadata

---

### **health-check-server.mjs** (187 lines)

**Location:** `health-check-server.mjs:1`

**Purpose:** Health check server providing status information and connectivity tests with proper dependency injection

**Key Components:**

##### 1. Server Setup (lines 6-15)
- Fastify server initialization
- Port configuration (PORT env var or 3002)
- FIGMA_TOKEN detection
  - **Line reference:** `health-check-server.mjs:10`

##### 2. Endpoints (lines 18-171)

**GET /** - Health check and module information
- **Returns:** Module status, version, environment, endpoints list
- **Line reference:** `health-check-server.mjs:18`

**GET /test** - API connectivity test
- **Query params:** `?teamId=YOUR_TEAM_ID` (optional)
- **Creates:** FigmaApiClient instance (line 67)
- **Injects:** fetcher into SDK (line 68)
- **Returns:** Success status and test results
- **Line reference:** `health-check-server.mjs:48`

**GET /components/team/:teamId** - Example team components endpoint
- **Creates:** FigmaApiClient with FIGMA_TOKEN (line 97)
- **Injects:** fetcher into SDK (line 98)
- **Returns:** Team components data
- **Line reference:** `health-check-server.mjs:87`

**GET /components/file/:fileKey** - Example file components endpoint
- **Line reference:** `health-check-server.mjs:116`

**GET /library/:teamId** - Example team library endpoint
- **Line reference:** `health-check-server.mjs:145`

##### 3. Server Startup (lines 174-187)
- `start()` - Async server initialization
  - **Listens:** 0.0.0.0:PORT
  - **Logs:** Server status and FIGMA_TOKEN presence
  - **Line reference:** `health-check-server.mjs:174`

**Dependencies:**
- `fastify` - Web server framework
- `@figma-api/fetch` - HTTP client (injected)
- `./index.mjs` - SDK module

**Error Handling:**
- Returns 400 for missing FIGMA_TOKEN
- Returns 500 for API errors
- Includes error type in responses

**Usage Example:**
```bash
# Start server
FIGMA_TOKEN=your_token node health-check-server.mjs

# Test endpoints
curl http://localhost:3002/
curl http://localhost:3002/test?teamId=123456
curl http://localhost:3002/library/123456
```

---

## 3. Test Coverage

**Total Test Lines:** 370
**Test Organization:**
- Unit tests: 1 describe block for FigmaComponentsService
- Test suites: 8 major categories
- Integration tests: None (unit tests with mocked fetcher)
- E2E tests: None

**Test-to-Source Ratio:** 0.65 (370 test lines / 570 service lines)

**Coverage Metrics:**
- Statement coverage: Not measured (requires coverage run)
- Branch coverage: Not measured
- Function coverage: All public methods tested
- Line coverage: Not measured

**Test Suite Breakdown:**

1. **Validation Methods Suite** (lines 52-109) - Tests: `_validateTeamId`, `_validateFileKey`, `_validateComponentKey`, `_validatePaginationParams`
   - **File:** `service.test.mjs:52`
   - **Tests:** 9 tests
   - **Coverage:** Parameter validation logic

2. **Components Methods Suite** (lines 126-195) - Tests: `getTeamComponents`, `getFileComponents`, `getComponent`
   - **File:** `service.test.mjs:126`
   - **Tests:** 6 tests
   - **Coverage:** HTTP calls, pagination, validation

3. **Component Sets Methods Suite** (lines 197-237) - Tests: `getTeamComponentSets`, `getFileComponentSets`, `getComponentSet`
   - **File:** `service.test.mjs:197`
   - **Tests:** 3 tests
   - **Coverage:** Component set operations

4. **Styles Methods Suite** (lines 239-279) - Tests: `getTeamStyles`, `getFileStyles`, `getStyle`
   - **File:** `service.test.mjs:239`
   - **Tests:** 3 tests
   - **Coverage:** Style operations

5. **Batch Operations Suite** (lines 281-316) - Tests: `batchGetComponents` with success and partial failures
   - **File:** `service.test.mjs:281`
   - **Tests:** 3 tests
   - **Coverage:** Parallel batch operations, error handling

6. **Convenience Methods Suite** (lines 319-366) - Tests: `getTeamLibraryContent`, `searchTeamComponentsByName`
   - **File:** `service.test.mjs:319`
   - **Tests:** 3 tests
   - **Coverage:** Combined operations, search

7. **Utility Methods Suite** (lines 368-380) - Tests: `getStats`, `healthCheck` (skipped)
   - **File:** `service.test.mjs:368`
   - **Tests:** 2 skipped tests
   - **Coverage:** Delegated to fetcher

**Test Results:**
```
Test Suites: 1 passed, 1 total
Tests:       2 skipped, 28 passed, 30 total
Time:        0.106 s
```

**Key Testing Patterns:**
- Mock fetcher with Jest for unit testing
- Test validation logic independently
- Test HTTP call parameters
- Test error scenarios
- Test batch operation success/failure handling

---

## 4. Health Check Server

### Port Configuration
- Default: `3002`
- Environment variable: `PORT`
- Host: `0.0.0.0` (all interfaces)

### Endpoints

#### GET /
**Purpose:** Health check and module information

**Response:**
```json
{
  "module": "figma-components",
  "version": "1.0.0",
  "status": "healthy|unhealthy",
  "environment": {
    "FIGMA_TOKEN": "present|missing"
  },
  "endpoints": [...],
  "availableMethods": [...]
}
```

**Use Cases:**
- Container health checks
- Monitoring system integration
- Service discovery

#### GET /test
**Purpose:** Test Figma API connectivity

**Query Parameters:**
- `teamId` (optional): Team ID to test with

**Response (with teamId):**
```json
{
  "success": true,
  "message": "Successfully connected to Figma API",
  "teamId": "123456",
  "componentsCount": 42
}
```

**Response (without teamId):**
```json
{
  "success": true,
  "message": "SDK initialized successfully. Provide ?teamId=YOUR_TEAM_ID to test API connectivity",
  "tokenPresent": true
}
```

**Error Response:**
```json
{
  "success": false,
  "error": "Error message",
  "type": "ErrorClassName"
}
```

#### GET /components/team/:teamId
**Purpose:** Example endpoint for team components

**Response:**
```json
{
  "success": true,
  "teamId": "123456",
  "components": {...}
}
```

#### GET /components/file/:fileKey
**Purpose:** Example endpoint for file components

#### GET /library/:teamId
**Purpose:** Example endpoint for complete team library

### Running Instructions

**Start Server:**
```bash
# With environment variable
export FIGMA_TOKEN=your_token_here
node health-check-server.mjs

# Or inline
FIGMA_TOKEN=your_token node health-check-server.mjs
```

**Expected Output:**
```
ğŸš€ Figma Components Health Check Server running on port 3002
   Health check: http://localhost:3002/
   Test endpoint: http://localhost:3002/test
   FIGMA_TOKEN: âœ“ Set
```

### Testing Examples

```bash
# Health check
curl http://localhost:3002/

# Test connectivity
curl http://localhost:3002/test?teamId=123456

# Get team components
curl http://localhost:3002/components/team/123456

# Get team library
curl http://localhost:3002/library/123456
```

---

## 5. Main Entry Point

### Entry File
**Path:** `index.mjs`
**Lines:** 34

### Exports Catalog

#### Core Exports
1. `FigmaComponentsService` - Service layer class
   - **Source:** `./src/core/service.mjs`
   - **Type:** Class
   - **Constructor:** `({ fetcher, logger = console })`

#### Interface Exports
2. `FigmaComponentsSDK` - SDK facade class (also default export)
   - **Source:** `./src/interfaces/sdk.mjs`
   - **Type:** Class
   - **Constructor:** `({ fetcher, logger = console })`

#### Exception Exports
3. `FigmaApiError` - Base error class
4. `RateLimitError` - Rate limit errors
5. `AuthenticationError` - Authentication failures
6. `AuthorizationError` - Authorization failures
7. `TeamNotFoundError` - Team not found
8. `FileNotFoundError` - File not found
9. `ComponentNotFoundError` - Component not found
10. `ComponentSetNotFoundError` - Component set not found
11. `StyleNotFoundError` - Style not found
12. `ValidationError` - Validation errors
13. `NetworkError` - Network errors
14. `HttpError` - HTTP errors
15. `ServerError` - Server errors
16. `TimeoutError` - Timeout errors
17. `PaginationError` - Pagination errors
18. `ScopeError` - OAuth scope errors
19. `createErrorFromResponse` - Error factory function
20. `isRetryableError` - Retry checker function

**Total Exports:** 20 named exports + 1 default export

### Package.json Configuration

```json
{
  "name": "figma-components-api",
  "version": "1.0.0",
  "type": "module",
  "main": "./index.mjs",
  "exports": {
    ".": "./index.mjs",
    "./service": "./src/core/service.mjs",
    "./exceptions": "./src/core/exceptions.mjs",
    "./sdk": "./src/interfaces/sdk.mjs",
    "./cli": "./src/interfaces/cli.mjs"
  },
  "bin": {
    "figma-components": "src/interfaces/cli.mjs"
  }
}
```

### Installation Instructions

**As NPM Package:**
```bash
npm install figma-components-api
```

**Peer Dependency:**
```bash
npm install @figma-api/fetch
```

**Local Development:**
```bash
cd /path/to/figma-api-module/mjs/components
npm install
npm test
```

### Usage Examples

**ES Modules:**
```javascript
// Default import (SDK)
import FigmaComponentsSDK from 'figma-components-api';

// Named imports
import { FigmaComponentsService, FigmaComponentsSDK } from 'figma-components-api';

// Service layer direct access
import { FigmaComponentsService } from 'figma-components-api/service';

// Exceptions
import { ValidationError, ComponentNotFoundError } from 'figma-components-api/exceptions';

// With HTTP client
import { FigmaApiClient } from '@figma-api/fetch';

const fetcher = new FigmaApiClient({ apiToken: process.env.FIGMA_TOKEN });
const sdk = new FigmaComponentsSDK({ fetcher });

const components = await sdk.getTeamComponents('123456');
```

**CLI Installation:**
```bash
# Global installation
npm install -g figma-components-api

# Usage
export FIGMA_API_TOKEN=your_token
figma-components components list-team 123456 --all --json
```

---

## 6. Architecture

### 6.1 Layer Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLI (cli.mjs)                                                   â”‚ â† Interface Layer
â”‚  - Commander-based command-line interface                        â”‚
â”‚  - Creates FigmaApiClient instances                              â”‚
â”‚  - Injects fetcher into SDK                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SDK (sdk.mjs)                                                   â”‚ â† Facade Layer
â”‚  - High-level convenience methods                                â”‚
â”‚  - Auto-pagination, batch operations, analytics                  â”‚
â”‚  - Receives fetcher via DI, delegates to service                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Service (service.mjs)                                           â”‚ â† Business Logic Layer
â”‚  - Core API operations                                           â”‚
â”‚  - Input validation and scope checking                           â”‚
â”‚  - Receives fetcher via DI (required parameter)                  â”‚
â”‚  - Makes HTTP calls via this.fetcher.get()                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  @figma-api/fetch (peer dependency)                              â”‚ â† HTTP Client Layer (Shared)
â”‚  - FigmaApiClient                                                â”‚
â”‚  - Rate limiting, caching, retries                               â”‚
â”‚  - Request/response interceptors                                 â”‚
â”‚  - Connection pooling via undici                                 â”‚
â”‚  - Proxy configuration                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Design Patterns

#### 1. Dependency Injection Pattern
**Applied:** `service.mjs:28-34`, `sdk.mjs:26-32`, `cli.mjs:27-42`

**Implementation:**
```javascript
// Service Layer (service.mjs:28)
constructor({ fetcher, logger = console } = {}) {
  if (!fetcher) {
    throw new Error('fetcher parameter is required. Please create and pass a FigmaApiClient instance.');
  }
  this.fetcher = fetcher;
  this.logger = logger;
}
```

**Benefit:**
- Decouples service from specific HTTP client implementation
- Enables testing with mock fetchers
- Centralizes HTTP client configuration
- Supports proxy, rate limiting, caching at single injection point

#### 2. Facade Pattern
**Applied:** `sdk.mjs:1-474`

**Implementation:**
- SDK provides simplified interface over service layer
- Manages service instantiation
- Adds convenience methods (auto-pagination, analytics)

**Benefit:**
- Simplifies common use cases
- Reduces boilerplate for consumers
- Provides ergonomic API

#### 3. Factory Pattern
**Applied:** `exceptions.mjs:233-292` (createErrorFromResponse)

**Implementation:**
```javascript
export function createErrorFromResponse(response, url, body = null) {
  const { status } = response;
  switch (status) {
    case 401: return new AuthenticationError(...);
    case 403: return new AuthorizationError(...);
    case 404: return new TeamNotFoundError(...);
    // ... more cases
  }
}
```

**Benefit:**
- Centralizes error creation logic
- Ensures consistent error handling
- Maps HTTP status codes to domain errors

#### 4. Strategy Pattern
**Applied:** `service.mjs:337-463` (batch operations)

**Implementation:**
- Batch operations use Promise.all for parallel execution
- Error handling strategy: capture individual failures
- Result aggregation strategy: separate successful/failed

**Benefit:**
- Optimizes bulk operations
- Graceful degradation on partial failures
- Detailed failure reporting

#### 5. Template Method Pattern
**Applied:** `sdk.mjs:54-76` (getAllTeamComponents), `sdk.mjs:127-149` (getAllTeamComponentSets)

**Implementation:**
```javascript
async getAllTeamComponents(teamId, maxItems = 1000) {
  const allComponents = [];
  let after = null;
  let hasMore = true;

  while (hasMore && allComponents.length < maxItems) {
    const response = await this.getTeamComponents(teamId, {
      pageSize: Math.min(100, maxItems - allComponents.length),
      after
    });
    // ... pagination logic
  }
  return allComponents;
}
```

**Benefit:**
- Reusable pagination algorithm
- Automatic handling of page tokens
- Respects rate limits

### 6.3 Data Flow Diagrams

#### Flow 1: Get Team Components (service.mjs:144-158)

```
Entry Point: service.getTeamComponents(teamId, options)
    â”‚
    â”œâ”€â†’ Validation: _validateTeamId(teamId) [service.mjs:40]
    â”‚   â””â”€â†’ Throws ValidationError if invalid
    â”‚
    â”œâ”€â†’ Validation: _validatePaginationParams(options) [service.mjs:85]
    â”‚   â””â”€â†’ Throws PaginationError if invalid
    â”‚
    â”œâ”€â†’ Validation: _validateScopes('getTeamComponents', [...]) [service.mjs:111]
    â”‚   â””â”€â†’ Logs warning if scopes missing
    â”‚
    â”œâ”€â†’ Build query params [service.mjs:149-153]
    â”‚   â””â”€â†’ { page_size, after, before }
    â”‚
    â”œâ”€â†’ HTTP Client Layer: this.fetcher.get() [service.mjs:157]
    â”‚   â”‚
    â”‚   â””â”€â†’ FigmaApiClient.get('/v1/teams/:teamId/components', params)
    â”‚       â”‚
    â”‚       â”œâ”€â†’ Rate Limiter check
    â”‚       â”œâ”€â†’ Cache check
    â”‚       â”œâ”€â†’ HTTP request via undici
    â”‚       â”œâ”€â†’ Response validation
    â”‚       â””â”€â†’ Return parsed JSON
    â”‚
    â””â”€â†’ Return: Paginated components response
```

#### Flow 2: Batch Get Components (service.mjs:337-373)

```
Entry Point: service.batchGetComponents(keys)
    â”‚
    â”œâ”€â†’ Validation: Check keys is non-empty array [service.mjs:338-340]
    â”‚   â””â”€â†’ Throws ValidationError if invalid
    â”‚
    â”œâ”€â†’ Create promises array [service.mjs:344-356]
    â”‚   â”‚
    â”‚   â””â”€â†’ For each key:
    â”‚       â”œâ”€â†’ Call: this.getComponent(key)
    â”‚       â”‚   â”‚
    â”‚       â”‚   â””â”€â†’ Validation: _validateComponentKey() [service.mjs:70]
    â”‚       â”‚   â””â”€â†’ HTTP: this.fetcher.get('/v1/components/:key') [service.mjs:191]
    â”‚       â”‚
    â”‚       â”œâ”€â†’ Success: { key, data, success: true }
    â”‚       â””â”€â†’ Error: { key, error: message, success: false }
    â”‚
    â”œâ”€â†’ Execute: Promise.all(promises) [service.mjs:358]
    â”‚   â””â”€â†’ Parallel execution via HTTP client connection pool
    â”‚
    â”œâ”€â†’ Aggregate results [service.mjs:361-362]
    â”‚   â”œâ”€â†’ successful = results.filter(r => r.success)
    â”‚   â””â”€â†’ failed = results.filter(r => !r.success)
    â”‚
    â”œâ”€â†’ Log warnings if failures [service.mjs:364-366]
    â”‚
    â””â”€â†’ Return: { successful, failed, total }
```

#### Flow 3: CLI Command Execution (cli.mjs:59-91)

```
Entry Point: figma-components components list-team <teamId>
    â”‚
    â”œâ”€â†’ Commander parses arguments and options [cli.mjs:66-80]
    â”‚
    â”œâ”€â†’ Spinner starts [cli.mjs:67]
    â”‚
    â”œâ”€â†’ Call: getSDK(command.optsWithGlobals()) [cli.mjs:68]
    â”‚   â”‚
    â”‚   â”œâ”€â†’ Get API token from options or env [cli.mjs:28]
    â”‚   â”‚   â””â”€â†’ Validation: Token required or exit(1) [cli.mjs:30-33]
    â”‚   â”‚
    â”‚   â”œâ”€â†’ Create: new FigmaApiClient({ apiToken }) [cli.mjs:36]
    â”‚   â”‚   â””â”€â†’ HTTP client initialization
    â”‚   â”‚
    â”‚   â””â”€â†’ Create: new FigmaComponentsSDK({ fetcher }) [cli.mjs:38]
    â”‚       â””â”€â†’ Injects fetcher into SDK
    â”‚
    â”œâ”€â†’ Call: sdk.getTeamComponents(teamId, options) [cli.mjs:73-82]
    â”‚   â”‚
    â”‚   â””â”€â†’ SDK delegates to service layer
    â”‚       â””â”€â†’ Service makes HTTP call via fetcher
    â”‚           â””â”€â†’ HTTP Client Layer handles request
    â”‚
    â”œâ”€â†’ Spinner succeeds [cli.mjs:75]
    â”‚
    â”œâ”€â†’ Output: outputResult(result, options) [cli.mjs:86]
    â”‚   â””â”€â†’ JSON or human-readable format
    â”‚
    â””â”€â†’ Exit: process.exit(0)
```

### 6.4 Dependencies

#### Runtime Dependencies
```json
{
  "chalk": "^5.3.0",        // CLI terminal colors
  "commander": "^12.0.0",   // CLI framework
  "ora": "^8.0.1"           // CLI spinners
}
```

#### Peer Dependencies
```json
{
  "@figma-api/fetch": "file:../figma-fetch"  // HTTP client (REQUIRED)
}
```

**Critical:** The module requires `@figma-api/fetch` to be installed as a peer dependency. All HTTP operations are delegated to FigmaApiClient via dependency injection.

#### Development Dependencies
```json
{
  "@figma-api/fetch": "file:../figma-fetch",  // For testing
  "@jest/globals": "^29.7.0",                 // Testing framework
  "eslint": "^8.57.0",                        // Linting
  "fastify": "^5.6.1",                        // Health check server
  "jest": "^29.7.0",                          // Test runner
  "prettier": "^3.2.5"                        // Code formatting
}
```

### 6.5 API Scopes

#### Required Figma API Scopes

**Team Operations:**
- `team_library_content:read` - Required for team components, sets, styles
- `files:read` - Required for all file access

**File Operations:**
- `library_content:read` - Required for file components, sets, styles
- `files:read` - Required for file access

**Individual Asset Operations:**
- `library_assets:read` - Required for individual component/set/style metadata
- `files:read` - Required for asset access

#### Scope-to-Operation Mapping

| Operation | Required Scopes |
|-----------|----------------|
| `getTeamComponents()` | `team_library_content:read`, `files:read` |
| `getTeamComponentSets()` | `team_library_content:read`, `files:read` |
| `getTeamStyles()` | `team_library_content:read`, `files:read` |
| `getFileComponents()` | `library_content:read`, `files:read` |
| `getFileComponentSets()` | `library_content:read`, `files:read` |
| `getFileStyles()` | `library_content:read`, `files:read` |
| `getComponent()` | `library_assets:read`, `files:read` |
| `getComponentSet()` | `library_assets:read`, `files:read` |
| `getStyle()` | `library_assets:read`, `files:read` |

**Validation:** Service layer validates scopes at `service.mjs:111-126` and logs warnings (not enforced client-side)

### 6.6 Performance Characteristics

#### Rate Limiting Strategy (from HTTP Client)
- Handled by `@figma-api/fetch` FigmaApiClient
- Automatic rate limit detection (429 responses)
- Retry-After header parsing
- Exponential backoff on rate limits

#### Caching Approach (from HTTP Client)
- Handled by `@figma-api/fetch` FigmaApiClient
- Configurable request caching
- Cache key generation from URL + params
- TTL-based cache expiration

#### Bulk Operation Optimizations
- Batch operations use `Promise.all` for parallelism (service.mjs:358)
- Connection pooling via undici in HTTP client
- Automatic pagination in SDK layer (sdk.mjs:54-76)

#### Connection Pooling
- Managed by undici in `@figma-api/fetch`
- Keep-alive connections
- Connection reuse across requests
- Configurable pool size in HTTP client

### 6.7 Security Considerations

#### Authentication Approach
- API token injection via constructor
- Token stored in HTTP client instance
- No token storage in service/SDK layers
- Environment variable support (`FIGMA_API_TOKEN`)

#### Authorization Model
- OAuth scope validation (informational only)
- Server-side scope enforcement by Figma API
- Client logs warnings for missing scopes

#### Input Validation Strategy
- Format validation for team IDs (numeric strings)
- Format validation for file keys (alphanumeric + dashes)
- Format validation for component keys (alphanumeric + colons/dashes)
- Pagination parameter validation (ranges, exclusivity)
- Validation errors thrown before HTTP calls

#### Proxy Configuration
- Supported via `@figma-api/fetch` HTTP client
- ProxyAgent configuration at HTTP client layer
- No proxy handling in service/SDK layers

### 6.8 Error Handling Hierarchy

```
Error (Built-in JavaScript Error)
â”‚
â””â”€â”€ FigmaApiError (Base - exceptions.mjs:9)
    â”‚
    â”œâ”€â”€ RateLimitError (exceptions.mjs:23)
    â”‚   â””â”€â”€ meta.retryable = true
    â”‚
    â”œâ”€â”€ AuthenticationError (exceptions.mjs:42)
    â”‚   â””â”€â”€ meta.retryable = false
    â”‚
    â”œâ”€â”€ AuthorizationError (exceptions.mjs:52)
    â”‚   â””â”€â”€ meta.retryable = false
    â”‚
    â”œâ”€â”€ TeamNotFoundError (exceptions.mjs:65)
    â”‚   â””â”€â”€ meta.retryable = false
    â”‚
    â”œâ”€â”€ FileNotFoundError (exceptions.mjs:78)
    â”‚   â””â”€â”€ meta.retryable = false
    â”‚
    â”œâ”€â”€ ComponentNotFoundError (exceptions.mjs:91)
    â”‚   â””â”€â”€ meta.retryable = false
    â”‚
    â”œâ”€â”€ ComponentSetNotFoundError (exceptions.mjs:104)
    â”‚   â””â”€â”€ meta.retryable = false
    â”‚
    â”œâ”€â”€ StyleNotFoundError (exceptions.mjs:117)
    â”‚   â””â”€â”€ meta.retryable = false
    â”‚
    â”œâ”€â”€ ValidationError (exceptions.mjs:130)
    â”‚   â””â”€â”€ meta.retryable = false
    â”‚
    â”œâ”€â”€ NetworkError (exceptions.mjs:144)
    â”‚   â””â”€â”€ meta.retryable = true
    â”‚
    â”œâ”€â”€ HttpError (exceptions.mjs:158)
    â”‚   â””â”€â”€ meta.retryable = (status >= 500 || status === 429)
    â”‚
    â”œâ”€â”€ ServerError (exceptions.mjs:177)
    â”‚   â””â”€â”€ meta.retryable = true
    â”‚
    â”œâ”€â”€ TimeoutError (exceptions.mjs:190)
    â”‚   â””â”€â”€ meta.retryable = true
    â”‚
    â”œâ”€â”€ PaginationError (exceptions.mjs:203)
    â”‚   â””â”€â”€ meta.retryable = false
    â”‚
    â””â”€â”€ ScopeError (exceptions.mjs:216)
        â””â”€â”€ meta.retryable = false
```

**Error Properties:**
- `name` - Error class name
- `message` - Error description
- `code` - Error code string
- `meta` - Metadata object with `retryable` flag
- `timestamp` - ISO timestamp

**Error Utilities:**
- `createErrorFromResponse(response, url, body)` - Factory for HTTP errors
- `isRetryableError(error)` - Determines if error supports retry

---

## 7. Summary

### Strengths

- âœ… **100% REQ003.md Compliant** - Full adherence to centralized HTTP client pattern
- âœ… **Proper Dependency Injection** - All layers use DI for HTTP client
- âœ… **No Direct HTTP Imports** - Zero undici/fetch imports in service/SDK layers
- âœ… **Comprehensive API Coverage** - All Figma Components API endpoints supported
- âœ… **Robust Error Handling** - 16 custom error classes with retry logic
- âœ… **Strong Input Validation** - Format validation before HTTP calls
- âœ… **Auto-Pagination Support** - SDK handles pagination automatically
- âœ… **Batch Operations** - Parallel execution with graceful degradation
- âœ… **CLI Interface** - Full command-line access with proper DI
- âœ… **Health Check Server** - Production-ready monitoring endpoints
- âœ… **Well Tested** - 28 passing unit tests with 100% success rate
- âœ… **Clean Architecture** - Clear separation of concerns (CLI â†’ SDK â†’ Service â†’ HTTP Client)

### Known Risks/Limitations

- âš  **Coverage Metrics** - Statement/branch coverage not measured (requires `npm test -- --coverage`)
- âš  **Skipped Tests** - 2 utility tests skipped (getStats, healthCheck - delegated to fetcher)
- âš  **No Integration Tests** - Only unit tests with mocked fetcher
- âš  **No E2E Tests** - No tests against real Figma API
- âš  **Client-Side Scope Validation** - OAuth scopes validated informationally (warnings only)
- âš  **Search Limitations** - Component search is client-side filtering (downloads all first)

### Metrics

- **Total lines of code:** 2,131 (source files)
  - service.mjs: 570 lines
  - sdk.mjs: 474 lines
  - cli.mjs: 536 lines
  - exceptions.mjs: 330 lines
  - health-check-server.mjs: 187 lines
  - index.mjs: 34 lines

- **Test coverage:** 370 lines (service.test.mjs)
- **Test-to-source ratio:** 0.65 (370 / 570)
- **API surface:**
  - Service: 18 public methods
  - SDK: 26 public methods
  - CLI: 18 commands
- **Test suites:** 1 suite, 30 tests (28 passed, 2 skipped)
- **Exports:** 20 named exports + 1 default export

### Dependencies

**Node.js:** >= 20.0.0
**NPM:** >= 9.0.0

**Runtime:**
- chalk: ^5.3.0
- commander: ^12.0.0
- ora: ^8.0.1

**Peer (REQUIRED):**
- @figma-api/fetch: file:../figma-fetch

**Development:**
- @figma-api/fetch: file:../figma-fetch
- @jest/globals: ^29.7.0
- eslint: ^8.57.0
- fastify: ^5.6.1
- jest: ^29.7.0
- prettier: ^3.2.5

### Operational Readiness

- âœ… **Has health check** - Health check server with multiple endpoints
- âœ… **Has comprehensive tests** - 28 passing unit tests
- âœ… **Has error tracking** - Structured error classes with metadata
- âœ… **Has input validation** - Pre-flight validation for all inputs
- âœ… **Has dependency injection** - Proper DI pattern throughout
- âœ… **Has CLI interface** - Production-ready command-line tool
- âœ… **Has documentation** - Comprehensive REQ003.md technical docs
- âœ… **ES modules compatible** - Modern JavaScript module system
- âš  **Missing coverage metrics** - Requires coverage run
- âš  **No integration tests** - Only mocked unit tests

---

## 8. Compliance Verification

### REQ003.md Checklist

#### âœ… Centralized HTTP Client Pattern
- [x] Service constructor accepts `fetcher` parameter (service.mjs:28)
- [x] Service stores `this.fetcher` (service.mjs:32)
- [x] Service throws error if fetcher not provided (service.mjs:29-31)
- [x] All HTTP calls use `this.fetcher.get()` (12 occurrences in service.mjs)
- [x] SDK constructor accepts `fetcher` parameter (sdk.mjs:26)
- [x] CLI creates FigmaApiClient instance (cli.mjs:36)
- [x] CLI injects fetcher into SDK (cli.mjs:38)

#### âœ… No Direct HTTP Imports
- [x] No `import { fetch }` from undici in service layer
- [x] No `import { fetch }` from undici in SDK layer
- [x] No `import { fetch }` from undici in CLI layer
- [x] No direct `fetch()` calls in business logic
- [x] Only `@figma-api/fetch` imports in CLI and health check

#### âœ… Package Configuration
- [x] `@figma-api/fetch` declared as peer dependency (package.json:76)
- [x] No undici in runtime dependencies (removed)
- [x] Proper ES module configuration (type: "module")

#### âœ… Architecture Documentation
- [x] Layer diagram shows HTTP Client Layer (section 6.1)
- [x] Dependency injection pattern documented (section 6.2.1)
- [x] Data flow diagrams show fetcher usage (section 6.3)
- [x] HTTP client error classes documented (section 6.8)

#### âœ… Error Handling
- [x] Custom error hierarchy defined (exceptions.mjs:9-224)
- [x] Retryable errors marked (meta.retryable flags)
- [x] Error factory pattern (createErrorFromResponse)
- [x] Network errors extend base class

#### âœ… Testing
- [x] Tests use mock fetcher (service.test.mjs:43-49)
- [x] Tests verify HTTP call parameters
- [x] Tests cover validation logic
- [x] All tests pass (28/28 passed)

### Compliance Score: 100%

All REQ003.md requirements met. Module demonstrates complete adherence to centralized HTTP client pattern with proper dependency injection throughout all layers.

---

## 9. Fix History

### Fixes Applied (2025-11-02)

#### Fix 1: CLI Dependency Injection (cli.mjs:36-38)
**Issue:** CLI was instantiating SDK with `apiToken` directly instead of injecting `fetcher`

**Before:**
```javascript
return new FigmaComponentsSDK({
  apiToken,
  logger: options.verbose ? console : { ... }
});
```

**After:**
```javascript
const fetcher = new FigmaApiClient({ apiToken });

return new FigmaComponentsSDK({
  fetcher,
  logger: options.verbose ? console : { ... }
});
```

**Impact:** CLI now properly follows DI pattern, aligning with service/SDK architecture

#### Fix 2: Remove undici from Runtime Dependencies (package.json:78-82)
**Issue:** `undici` was listed in runtime dependencies despite no usage

**Before:**
```json
"dependencies": {
  "chalk": "^5.3.0",
  "commander": "^12.0.0",
  "ora": "^8.0.1",
  "undici": "^6.21.0"
}
```

**After:**
```json
"dependencies": {
  "chalk": "^5.3.0",
  "commander": "^12.0.0",
  "ora": "^8.0.1"
}
```

**Impact:** Reduced dependency footprint, clarified that HTTP client comes from peer dependency

#### Fix 3: Test Mock Refactoring (service.test.mjs:43-59)
**Issue:** Tests were mocking non-existent `client.mjs` module

**Before:**
```javascript
jest.unstable_mockModule('../../src/core/client.mjs', () => ({
  default: MockFigmaComponentsClient,
  FigmaComponentsClient: MockFigmaComponentsClient
}));
```

**After:**
```javascript
import { FigmaComponentsService } from '../../src/core/service.mjs';
import { ValidationError, PaginationError } from '../../src/core/exceptions.mjs';

// ...

mockFetcher = {
  get: jest.fn(),
  post: jest.fn(),
  request: jest.fn(),
  getStats: jest.fn(() => ({ totalRequests: 0 })),
  healthCheck: jest.fn(() => Promise.resolve(true))
};

service = new FigmaComponentsService({
  fetcher: mockFetcher,
  logger: mockLogger
});
```

**Impact:** Tests now properly mock fetcher via DI, all tests pass (28/28)

### Verification Results

**Module Load Test:**
```bash
âœ… Module loads successfully
```

**Test Results:**
```
âœ… Test Suites: 1 passed, 1 total
âœ… Tests: 2 skipped, 28 passed, 30 total
âœ… Time: 0.106 s
```

**HTTP Client Pattern Verification:**
```bash
âœ… No undici imports in src/
âœ… All fetcher usage via this.fetcher.get()
âœ… Proper DI in constructor
```

**Compliance Status:** âœ… 100% REQ003.md Compliant

---

## Appendix: Quick Reference

### Common Operations

```javascript
import { FigmaApiClient } from '@figma-api/fetch';
import { FigmaComponentsSDK } from 'figma-components-api';

// Initialize
const fetcher = new FigmaApiClient({ apiToken: process.env.FIGMA_TOKEN });
const sdk = new FigmaComponentsSDK({ fetcher });

// Get team components (paginated)
const components = await sdk.getTeamComponents('123456', { pageSize: 50 });

// Get all team components (auto-pagination)
const allComponents = await sdk.getAllTeamComponents('123456');

// Get complete library
const library = await sdk.getTeamLibrary('123456');

// Search components
const results = await sdk.searchComponents('123456', 'button');

// Batch operations
const batch = await sdk.batchGetComponents(['key1', 'key2', 'key3']);

// Analytics
const analytics = await sdk.getTeamLibraryAnalytics('123456');
```

### CLI Commands

```bash
# List team components
figma-components components list-team 123456 --all --json

# Search components
figma-components components search 123456 "button"

# Get complete library
figma-components library get-team 123456 --pretty

# Export library
figma-components library export 123456 > library.json

# Health check
figma-components health
```

### Health Check Server

```bash
# Start server
FIGMA_TOKEN=your_token node health-check-server.mjs

# Test endpoints
curl http://localhost:3002/
curl http://localhost:3002/test?teamId=123456
curl http://localhost:3002/library/123456
```

---

**End of Technical Documentation**
