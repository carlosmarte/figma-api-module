# Figma Comments Module - Technical Documentation

## Table of Contents
1. [Overview](#overview)
2. [Source Code Structure](#source-code-structure)
3. [Test Coverage](#test-coverage)
4. [Health Check Server](#health-check-server)
5. [Main Entry Point](#main-entry-point)
6. [Architecture](#architecture)

---

## Overview

The Figma Comments Module provides a comprehensive API for managing comments, reactions, threading, and analytics in Figma files. It features a multi-layer architecture with CLI, SDK, and Service interfaces.

**Key Capabilities:**
- Comment CRUD operations (create, read, delete)
- Reaction system with emoji support
- Thread management and replies
- Search and filtering
- Bulk operations
- Analytics and engagement metrics
- Export to JSON/CSV/Markdown formats
- Command-line interface

---

## Source Code Structure

### Directory Tree
```
src/
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ client.mjs.bak      (backup - HTTP client implementation)
‚îÇ   ‚îú‚îÄ‚îÄ exceptions.mjs      (error handling classes)
‚îÇ   ‚îî‚îÄ‚îÄ service.mjs         (business logic layer)
‚îî‚îÄ‚îÄ interfaces/
    ‚îú‚îÄ‚îÄ cli.mjs             (command-line interface)
    ‚îî‚îÄ‚îÄ sdk.mjs             (high-level SDK facade)
```

---

### File Details

#### **src/core/exceptions.mjs** (228 lines)
**Location:** `src/core/exceptions.mjs:1`

**Purpose:** Comprehensive error handling system for the Figma Comments API

**Key Components:**

1. **Base Error Class**
   - `FigmaCommentsError` - Parent class with structured metadata
   - Properties: `code`, `meta`, `timestamp`
   - Provides consistent error formatting

2. **HTTP Error Classes**
   - `ApiError` - General API failures with HTTP status codes
   - `RateLimitError` - Rate limiting errors with retry-after information
   - `NetworkError` - Network connectivity issues

3. **Authentication/Authorization Errors**
   - `AuthenticationError` - Invalid credentials (HTTP 401)
   - `AuthorizationError` - Insufficient permissions (HTTP 403)

4. **Validation Errors**
   - `ValidationError` - Invalid input parameters
   - `NotFoundError` - Resource not found (HTTP 404)

5. **Domain-Specific Errors**
   - `CommentError` - Comment operation failures
   - `CommentPermissionError` - Comment-specific permission issues
   - `CommentValidationError` - Comment data validation failures
   - `FileError`, `FileNotFoundError`, `FileAccessError` - File-related errors

6. **Utility Functions**
   - `createErrorFromResponse()` - Converts HTTP responses to appropriate error types
   - Automatic error type selection based on status code

**Architecture Pattern:** Hierarchical error inheritance with metadata enrichment

**Usage Example:**
```javascript
throw new ValidationError('Invalid file key', {
  code: 'INVALID_FILE_KEY',
  meta: { fileKey: 'abc' }
});
```

---

#### **src/core/service.mjs** (768 lines)
**Location:** `src/core/service.mjs:1`

**Purpose:** Business logic layer for Figma Comments operations

**Constructor:**
```javascript
constructor({ fetcher, apiToken, logger, validateInput = true })
```
- `fetcher`: FigmaApiClient instance from `@figma-api/fetch`
- `apiToken`: Figma API token
- `logger`: Optional logger (defaults to console)
- `validateInput`: Enable/disable input validation

**Key Responsibilities:**

##### 1. Core Comment Operations (lines 50-136)
- `getFileComments(fileKey, options = {})` - Fetch all comments
  - Options: `as_md` for markdown formatting
  - Returns: Array of comment objects

- `addComment(fileKey, commentData)` - Create new comment
  - Supports positioning (coordinates or node-based)
  - Supports replies via `parent_id`
  - Validates message length (max 8000 chars)

- `deleteComment(fileKey, commentId)` - Remove comment by ID
  - Returns: Success/failure status

##### 2. Reaction Management (lines 138-367)
- `getCommentReactions(fileKey, commentId)` - Fetch reactions for a comment
  - **Required scopes:** `file_comments:read`, `files:read`
  - Returns: Array of reaction objects with user info

- `addCommentReaction(fileKey, commentId, emoji)` - Add emoji reaction
  - **Required scope:** `file_comments:write`
  - Validates emoji format

- `deleteCommentReaction(fileKey, commentId, emoji)` - Remove emoji reaction

- `toggleCommentReaction(fileKey, commentId, emoji)` - Smart toggle
  - Adds reaction if not present
  - Removes reaction if already present

- `getFileReactionSummary(fileKey)` - Comprehensive analytics
  - Total reactions count
  - Emoji usage statistics
  - Top emojis ranking
  - Most reacted comments
  - User activity tracking

##### 3. Thread Management (lines 372-402)
- `getCommentThread(fileKey, commentId)` - Fetch comment with sorted replies
  - Returns parent comment with nested replies
  - Chronologically sorted

- `replyToComment(fileKey, parentCommentId, message)` - Create threaded reply
  - Auto-sets `parent_id`

##### 4. Search & Filtering (lines 404-458)
- `searchComments(fileKey, query)` - Content and user search
  - Searches message content and user names
  - Results sorted by relevance

- `getCommentsByUser(fileKey, userId)` - Filter by user ID
  - Returns comments sorted by date (newest first)

- `getUnresolvedComments(fileKey)` - Filter by resolution status
  - Returns only unresolved comments

##### 5. Bulk Operations (lines 477-615)
- `batchDeleteComments(fileKey, commentIds)` - Delete multiple comments
  - Returns success/failure tracking for each comment
  - Continues on partial failures

- `bulkAddComments(fileKey, commentsData)` - Create multiple comments
  - Returns results with error handling per comment

##### 6. Analytics (lines 509-558)
- `getCommentStatistics(fileKey)` - Comprehensive file statistics
  - Total/resolved/unresolved counts
  - Thread analysis (thread count, avg replies)
  - User engagement metrics (unique commenters)
  - Date range analysis (first/last comment timestamps)

##### 7. Export Functionality (lines 560-583)
- `exportComments(fileKey, format = 'json')` - Export comments
  - Formats: `json`, `csv`, `markdown`
  - CSV includes: ID, User, Message, Created, Resolved status
  - Markdown includes threaded structure

##### 8. Utility Methods (lines 617-720)
- `getCommentHistory(fileKey, startDate, endDate)` - Time-based filtering
- `archiveResolvedComments(fileKey)` - Simulated archiving
- Private validation methods:
  - `_validateFileKey()`, `_validateCommentId()`, `_validateReactionEmoji()`
  - `_validateCommentData()` - Message validation
  - `_formatPosition()` - Position data normalization
  - `_getCurrentUserId()` - User identification
  - `_exportToCsv()`, `_exportToMarkdown()` - Export helpers

**Dependencies:**
- Requires `@figma-api/fetch` package
- Optional logger (defaults to console)
- Configurable input validation

**Error Handling:**
- Validates all inputs before API calls
- Throws specific error types from exceptions.mjs
- Provides detailed error metadata

---

#### **src/interfaces/sdk.mjs** (515 lines)
**Location:** `src/interfaces/sdk.mjs:1`

**Purpose:** High-level developer-friendly SDK facade

**Constructor:**
```javascript
constructor({ fetcher, apiToken, logger })
```
- Creates internal `FigmaCommentsService` instance
- Wraps service methods with cleaner APIs

**Key Features:**

##### 1. Simplified Core Operations (lines 38-81)
- `getComments(fileKey, options)` - Alias for `getFileComments()`
- `addComment(fileKey, message, options)` - Simplified comment creation
- `deleteComment(fileKey, commentId)` - Comment deletion
- `replyToComment(fileKey, parentCommentId, message)` - Reply creation

##### 2. Reaction API (lines 83-187)
- `getCommentReactions(fileKey, commentId)` - Get reactions
- `addReaction(fileKey, commentId, emoji)` - Add reaction
- `removeReaction(fileKey, commentId, emoji)` - Remove reaction
- `toggleReaction(fileKey, commentId, emoji)` - Smart toggle
- `getReactionSummary(fileKey)` - Full analytics
- `getTopReactions(fileKey, limit = 5)` - Popular emojis leaderboard
- `getMostReactedComments(fileKey, limit = 5)` - Most engaged comments

**Quick React Feature:**
- `quickReact(fileKey, commentId, reactionType)` - Convenience method
- Supported reaction types with emoji mapping:
  - `like` ‚Üí üëç
  - `dislike` ‚Üí üëé
  - `love` ‚Üí ‚ù§Ô∏è
  - `laugh` ‚Üí üòÇ
  - `wow` ‚Üí üòÆ
  - `sad` ‚Üí üò¢
  - `angry` ‚Üí üò†
  - `celebrate` ‚Üí üéâ
  - `fire` ‚Üí üî•
  - `rocket` ‚Üí üöÄ

##### 3. Enhanced Comment Operations (lines 189-267)
- `addCommentAtCoordinates(fileKey, message, x, y)` - Position-based comments
- `addCommentToNode(fileKey, message, nodeId, offsetX, offsetY)` - Node-attached comments
- `getCommentThread(fileKey, commentId)` - Thread retrieval
- `searchComments(fileKey, query)` - Search functionality
- `getCommentsByUser(fileKey, userId)` - User filtering
- `getUnresolvedComments(fileKey)` - Filter by resolution status
- `getCommentStatistics(fileKey)` - Analytics wrapper

##### 4. Bulk Operations (lines 269-308)
- `exportComments(fileKey, format)` - Export functionality
- `bulkAddComments(fileKey, commentsData)` - Batch creation
- `bulkDeleteComments(fileKey, commentIds)` - Batch deletion
- `getRecentComments(fileKey, days = 7)` - Time-filtered queries

##### 5. Convenience Methods (lines 310-434)
- `getCommentsGroupedByThread(fileKey)` - Auto-grouped threading
  - Returns object with top-level comments and their replies

- `getCommentActivity(fileKey, days = 30)` - Daily activity breakdown
  - Returns comments grouped by date

- `findMentions(fileKey, userId)` - Mention detection
  - Searches for @userId patterns in messages

- `getEngagementMetrics(fileKey)` - Enhanced metrics including reactions
  - Calculates:
    - Response rate (comments with replies)
    - Active users count
    - Thread analysis (avg replies per thread)
    - Reaction rate (comments with reactions)
    - Top emojis
    - Engagement score (reactions + replies)

- `archiveOldComments(fileKey, daysOld = 90)` - Archival simulation
  - Identifies old resolved comments for archiving

##### 6. Private Helpers (lines 462-512)
- `_findMostActiveUser(comments)` - User activity ranking
- `_findLongestThread(comments)` - Thread size analysis

**Architecture Pattern:** Facade pattern with composition over inheritance

**Usage Example:**
```javascript
const sdk = new FigmaCommentsSDK({ fetcher, apiToken });

// Simple comment
await sdk.addComment('fileKey', 'Great design!');

// Quick reaction
await sdk.quickReact('fileKey', 'commentId', 'love');

// Analytics
const metrics = await sdk.getEngagementMetrics('fileKey');
```

---

#### **src/interfaces/cli.mjs** (686 lines)
**Location:** `src/interfaces/cli.mjs:1`

**Purpose:** Full-featured command-line interface for Figma Comments

**Global Options:**
- `-t, --token <token>` - Figma API token (or FIGMA_TOKEN env var)
- `-v, --verbose` - Enable detailed output
- `--no-cache` - Disable request caching
- `--timeout <ms>` - Set request timeout

**Commands:**

##### Comment Management Commands
1. **list** `<file-key>` - List all comments
   - Options: `--threads`, `--unresolved`, `--by-user <userId>`
   - Output: Table or JSON format

2. **add** `<file-key>` - Add a new comment
   - Options: `--message`, `--x`, `--y`, `--node`, `--parent`
   - Interactive prompts if options not provided

3. **delete** `<file-key> <comment-id>` - Delete a comment
   - Includes confirmation prompt

4. **reply** `<file-key> <comment-id>` - Reply to a comment
   - Option: `--message`

5. **thread** `<file-key> <comment-id>` - Get full comment thread
   - Shows parent and all replies

6. **search** `<file-key> <query>` - Search comments
   - Searches message content and user names

##### Reaction Management Commands
7. **reactions** `<file-key> <comment-id>` - Get reactions for a comment
   - Shows emoji and user information

8. **react** `<file-key> <comment-id> <emoji>` - Add a reaction
   - Option: `--toggle` (toggle instead of add)

9. **unreact** `<file-key> <comment-id> <emoji>` - Remove a reaction

10. **quick-react** `<file-key> <comment-id> <type>` - Quick emoji reactions
    - Types: like, love, laugh, wow, sad, angry, celebrate, fire, rocket

11. **reaction-summary** `<file-key>` - Get file-wide reaction analytics
    - Shows total reactions, top emojis, most reacted comments

12. **top-reactions** `<file-key>` - Get most popular emojis
    - Option: `--limit <number>` (default: 5)

13. **most-reacted** `<file-key>` - Get most reacted comments
    - Option: `--limit <number>` (default: 5)

##### Analytics & Export Commands
14. **stats** `<file-key>` - Get comment statistics
    - Options: `--engagement`, `--activity <days>`
    - Shows counts, threads, users, date ranges

15. **export** `<file-key>` - Export comments
    - Options: `--format <json|csv|markdown>`, `--output <file>`
    - Defaults to JSON format

16. **recent** `<file-key>` - Get recent comments
    - Option: `--days <number>` (default: 7)

##### Bulk Operations Commands
17. **bulk-delete** `<file-key>` - Delete multiple comments
    - Option: `--ids <comma-separated-ids>`
    - Shows success/failure for each deletion

##### System Commands
18. **health** - Check API health
    - Validates token and API connectivity

**Features:**
- Spinner indicators (using `ora` package)
- Colorized output (using `chalk` package)
- Table formatting for lists
- JSON output support (`--json` flag)
- File output for exports
- Comprehensive error handling
- Verbose mode for debugging

**Usage Example:**
```bash
# List comments
figma-comments list abc123 --token YOUR_TOKEN

# Add reaction
figma-comments react abc123 comment456 "üëç"

# Export to CSV
figma-comments export abc123 --format csv --output comments.csv

# Get engagement metrics
figma-comments stats abc123 --engagement
```

---

#### **src/core/client.mjs.bak** (443 lines)
**Location:** `src/core/client.mjs.bak:1`

**Purpose:** Backup of HTTP client implementation (replaced by `@figma-api/fetch`)

**Key Classes:**

##### 1. RateLimiter (lines 27-75)
- Implements token bucket algorithm
- 60 requests per minute with burst tokens
- Sliding window implementation
- Statistics tracking (requests, waits, avg wait time)

##### 2. RequestCache (lines 80-148)
- LRU cache with TTL (5 minutes default)
- Hit rate tracking
- URL + parameters key generation
- Automatic expiration

##### 3. FigmaCommentsClient (lines 153-443)
- HTTP client with retry logic
- Exponential backoff (2x factor, max 5 retries)
- Proxy support (HTTP_PROXY environment variable)
- Response parsing (JSON/text/binary)
- Request statistics tracking
- Health check endpoint

**Configuration Options:**
```javascript
{
  apiToken: string,
  baseUrl: string,
  timeout: number,
  maxRetries: number,
  enableCache: boolean,
  enableRateLimit: boolean,
  logger: object,
  proxy: string
}
```

**Note:** This file is a backup. The module now uses the shared `@figma-api/fetch` package for HTTP operations, which provides centralized HTTP client functionality across all Figma API modules.

---

## Test Coverage

### Directory Structure
```
tests/unit/
‚îú‚îÄ‚îÄ service.test.mjs        (415 lines - Core service tests)
‚îî‚îÄ‚îÄ reactions.test.mjs      (441 lines - Reaction feature tests)
```

---

### **tests/unit/service.test.mjs** (415 lines)
**Location:** `tests/unit/service.test.mjs:1`

**Purpose:** Unit tests for FigmaCommentsService core functionality

**Test Suites (15 describe blocks):**

#### 1. Constructor Tests (lines 24-32)
- Validates required `client` or `apiToken` parameter
- Proper initialization with configuration

#### 2. getFileComments Tests (lines 34-65)
- Successfully retrieves comments from API
- Handles `as_md` (markdown) format option
- Validates file key parameter

#### 3. addComment Tests (lines 67-136)
- Basic comment creation
- Position handling:
  - Coordinate-based positioning (x, y)
  - Node-based positioning (node_id, node_offset)
- Reply comments with `parent_id`
- Validation tests:
  - Rejects null comment data
  - Rejects empty message
  - Enforces message length limit (8000 chars)

#### 4. deleteComment Tests (lines 138-159)
- Successful comment deletion
- Parameter validation (file key, comment ID)

#### 5. getCommentThread Tests (lines 161-186)
- Thread retrieval with parent and replies
- Reply sorting (chronological order)
- NotFoundError for missing comments

#### 6. searchComments Tests (lines 188-218)
- Message content search
- User name inclusion in search
- Relevance-based sorting

#### 7. getCommentsByUser Tests (lines 220-236)
- User ID filtering
- Date sorting (newest first)

#### 8. getUnresolvedComments Tests (lines 238-254)
- Resolution status filtering
- Excludes resolved comments

#### 9. batchDeleteComments Tests (lines 256-280)
- Bulk deletion with success/failure tracking
- Partial success handling
- Input validation (array of IDs)

#### 10. getCommentStatistics Tests (lines 282-325)
- Comprehensive statistics calculation:
  - Total/resolved/unresolved counts
  - Thread analysis (count, avg replies)
  - Unique user counting
  - Date range (first/last comment)

#### 11. exportComments Tests (lines 327-366)
- JSON export format
- CSV formatting with headers
- Markdown generation with threading
- Format validation (rejects invalid formats)

#### 12. bulkAddComments Tests (lines 368-392)
- Bulk creation with error tracking
- Individual comment success/failure status

#### 13. getCommentHistory Tests (lines 394-414)
- Date range filtering (startDate, endDate)
- Chronological sorting (newest first)

**Testing Pattern:**
- Mock-based unit tests using Jest
- Mocked HTTP client (`fetcher.request`)
- Isolated testing (no real API calls)
- Comprehensive validation coverage

---

### **tests/unit/reactions.test.mjs** (441 lines)
**Location:** `tests/unit/reactions.test.mjs:1`

**Purpose:** Unit tests for reaction functionality in Service and SDK layers

**Test Suites (6 main describe blocks):**

#### FigmaCommentsService - Reactions

##### 1. getCommentReactions Tests (lines 30-72)
- Successfully retrieves reactions from API
- Validates file key and comment ID parameters
- HTTP 403 error handling with scope messages:
  - Returns helpful error for missing `file_comments:read` scope
  - Returns helpful error for missing `files:read` scope
- General error handling

##### 2. addCommentReaction Tests (lines 74-119)
- Successful reaction addition
- Emoji validation:
  - Rejects empty emoji
  - Rejects null emoji
  - Enforces emoji length limits
- Permission error handling (403 with scope messages)

##### 3. deleteCommentReaction Tests (lines 121-147)
- Successful reaction deletion
- Permission error handling
- Parameter validation

##### 4. toggleCommentReaction Tests (lines 149-185)
- **Add behavior:** Adds reaction when not present
- **Remove behavior:** Removes reaction when already present
- User ID resolution for current user

##### 5. getFileReactionSummary Tests (lines 187-237)
- Complete analytics calculation:
  - Total reactions count across all comments
  - Emoji counting and grouping
  - Top reactions sorting
  - Most reacted comments ranking
- Graceful failure handling (continues on partial failures)

#### FigmaCommentsSDK - Reactions (lines 240-385)

##### 6. SDK Method Tests
- `getCommentReactions()` - Wrapper validation
- `addReaction()` - Service method delegation
- `removeReaction()` - Service method delegation
- `toggleReaction()` - Service method delegation
- `quickReact()` - Emoji mapping validation:
  - Maps 'like' ‚Üí 'üëç'
  - Maps 'love' ‚Üí '‚ù§Ô∏è'
  - Maps 'fire' ‚Üí 'üî•'
  - etc.
- `getReactionSummary()` - Analytics wrapper
- `getTopReactions()` - Top emoji leaderboard
- `getMostReactedComments()` - Engagement ranking
- `getEngagementMetrics()` - Enhanced metrics with reactions:
  - Reaction rate calculation
  - Top emojis identification
  - Engagement score computation

#### Reaction Validation Tests (lines 387-441)

##### 7. Validation & Error Handling
- Emoji format validation
- Scope error messages:
  - Clear messaging for `file_comments:read` requirement
  - Clear messaging for `file_comments:write` requirement
- Required permissions metadata in errors

**Test Coverage Summary:**
- **Total lines:** ~856 lines of tests
- **Core functionality:** ‚úì All CRUD operations
- **Advanced features:** ‚úì Reactions, analytics, bulk operations
- **Error cases:** ‚úì Validation, authorization, network errors
- **Edge cases:** ‚úì Empty data, missing parameters, permission errors

---

## Health Check Server

### **health-check-server.mjs**
**Location:** `health-check-server.mjs:1`

**Purpose:** Standalone Fastify server for development testing and monitoring

**Configuration:**
- **Port:** 3001 (configurable via `PORT` environment variable)
- **Framework:** Fastify
- **Dependencies:** `@figma-api/fetch`, `dotenv`

**Endpoints:**

#### 1. GET / (lines 18-42)
**Purpose:** Module information and status check

**Response:**
```json
{
  "module": "figma-comments",
  "version": "1.x.x",
  "status": "healthy" | "unhealthy",
  "message": "Health check passed" | "FIGMA_TOKEN not configured",
  "timestamp": "2025-11-01T...",
  "methods": [
    "getFileComments",
    "addComment",
    "deleteComment",
    "getCommentReactions",
    ...
  ],
  "endpoints": {
    "/": "Module information and health status",
    "/test": "Test token and connectivity",
    "/comments/:fileKey": "Get comments for a file"
  }
}
```

**Status Determination:**
- `healthy` - FIGMA_TOKEN environment variable is set
- `unhealthy` - FIGMA_TOKEN not configured

#### 2. GET /test (lines 45-81)
**Purpose:** Validate token and test API connectivity

**Query Parameters:**
- `fileKey` (optional) - File key to test comment retrieval

**Response (without fileKey):**
```json
{
  "status": "ok",
  "message": "Token is configured",
  "hasToken": true,
  "timestamp": "2025-11-01T..."
}
```

**Response (with fileKey):**
```json
{
  "status": "ok",
  "message": "Successfully retrieved comments",
  "commentsCount": 42,
  "fileKey": "abc123",
  "timestamp": "2025-11-01T..."
}
```

**Error Response:**
```json
{
  "status": "error",
  "message": "Error message",
  "error": "Detailed error info"
}
```

#### 3. GET /comments/:fileKey (lines 84-109)
**Purpose:** Full comment retrieval example

**Path Parameters:**
- `fileKey` (required) - Figma file key

**Response:**
```json
{
  "fileKey": "abc123",
  "comments": [...],
  "count": 42,
  "timestamp": "2025-11-01T..."
}
```

**Error Response:**
```json
{
  "error": "Error message",
  "details": "Detailed error information"
}
```

**Features:**
- Environment detection (FIGMA_TOKEN presence)
- Comprehensive error responses with details
- Request/response logging (Fastify built-in)
- Graceful error handling
- CORS enabled (if configured)

**Use Cases:**
1. **Development Testing** - Quick API endpoint testing during development
2. **CI/CD Health Checks** - Automated health verification in pipelines
3. **API Connectivity Verification** - Validate token and connection
4. **Example Implementation** - Reference for SDK usage patterns

**Running the Server:**
```bash
# Set environment variable
export FIGMA_TOKEN=your_token_here

# Start server
node health-check-server.mjs

# Server starts on http://localhost:3001
```

**Testing Examples:**
```bash
# Check health
curl http://localhost:3001/

# Test token
curl http://localhost:3001/test

# Test with file
curl http://localhost:3001/test?fileKey=abc123

# Get comments
curl http://localhost:3001/comments/abc123
```

---

## Main Entry Point

### **index.mjs**
**Location:** `index.mjs:1`

**Purpose:** Public API surface and module exports

**Exports:**

#### Core Classes (lines 11-13)
```javascript
export {
  FigmaCommentsService,  // Business logic layer
  FigmaCommentsSDK,      // High-level facade (also default export)
}
```

#### Error Classes (lines 15-33)
```javascript
export {
  FigmaCommentsError,      // Base error class
  ApiError,                 // General API errors
  AuthenticationError,      // 401 errors
  AuthorizationError,       // 403 errors
  ValidationError,          // Input validation errors
  NotFoundError,            // 404 errors
  RateLimitError,           // Rate limiting errors
  NetworkError,             // Network connectivity errors
  CommentError,             // Comment-specific errors
  CommentPermissionError,   // Comment permission errors
  CommentValidationError,   // Comment validation errors
  FileError,                // File-related errors
  FileNotFoundError,        // File not found errors
  FileAccessError,          // File access errors
  createErrorFromResponse,  // Error factory function
}
```

#### Utility Classes (line 36)
```javascript
export {
  RateLimiter,     // From @figma-api/fetch
  RequestCache,    // From @figma-api/fetch
}
```

#### Default Export (line 39)
```javascript
export default FigmaCommentsSDK;  // Primary SDK class
```

**Package Configuration (package.json):**

**Module Type:**
```json
{
  "type": "module"
}
```

**Entry Points:**
```json
{
  "main": "./index.mjs",
  "types": "./index.d.mts"
}
```

**CLI Binary:**
```json
{
  "bin": {
    "figma-comments": "./src/interfaces/cli.mjs"
  }
}
```

**Node Version:**
```json
{
  "engines": {
    "node": ">=20.0.0"
  }
}
```

**Dependencies:**
```json
{
  "dependencies": {
    "chalk": "^5.3.0",
    "commander": "^12.0.0",
    "dotenv": "^16.4.1",
    "fastify": "^5.2.1",
    "ora": "^8.0.1"
  },
  "peerDependencies": {
    "@figma-api/fetch": "*"
  },
  "devDependencies": {
    "eslint": "^9.14.0",
    "jest": "^29.7.0",
    "prettier": "^3.3.3"
  }
}
```

**Usage Examples:**

**ES Modules (Recommended):**
```javascript
import FigmaCommentsSDK from '@figma-api/comments';
// or
import { FigmaCommentsSDK, FigmaCommentsService } from '@figma-api/comments';

const sdk = new FigmaCommentsSDK({ fetcher, apiToken });
```

**Error Handling:**
```javascript
import { CommentError, ValidationError } from '@figma-api/comments';

try {
  await sdk.addComment(fileKey, message);
} catch (error) {
  if (error instanceof ValidationError) {
    console.error('Invalid input:', error.message);
  } else if (error instanceof CommentError) {
    console.error('Comment operation failed:', error.message);
  }
}
```

**CLI Installation:**
```bash
npm install -g @figma-api/comments
figma-comments --help
```

---

## Architecture

### Layer Structure

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CLI (cli.mjs)                      ‚îÇ ‚Üê User Interface Layer
‚îÇ  - Commander.js commands            ‚îÇ   (18 commands, interactive prompts)
‚îÇ  - Terminal output formatting       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  SDK (sdk.mjs)                      ‚îÇ ‚Üê Facade Layer
‚îÇ  - Developer-friendly API           ‚îÇ   (High-level convenience methods)
‚îÇ  - Convenience methods              ‚îÇ
‚îÇ  - Quick reactions                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Service (service.mjs)              ‚îÇ ‚Üê Business Logic Layer
‚îÇ  - Core business logic              ‚îÇ   (Comment CRUD, reactions, analytics)
‚îÇ  - Validation                       ‚îÇ
‚îÇ  - Data transformation              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Fetcher (@figma-api/fetch)         ‚îÇ ‚Üê HTTP Client Layer
‚îÇ  - HTTP requests                    ‚îÇ   (Rate limiting, caching, retries)
‚îÇ  - Rate limiting                    ‚îÇ
‚îÇ  - Caching                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Exceptions (exceptions.mjs)        ‚îÇ ‚Üê Cross-cutting Concern
‚îÇ  - Error hierarchy                  ‚îÇ   (Structured error handling)
‚îÇ  - Error factory                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Design Patterns

#### 1. Facade Pattern
- **SDK** wraps **Service** complexity
- Provides simplified, developer-friendly interface
- Example: `sdk.quickReact()` vs `service.addCommentReaction()`

#### 2. Dependency Injection
- Service accepts `fetcher` parameter (not hardcoded)
- Enables testing with mock fetchers
- Configurable logger and validation

#### 3. Error Hierarchy
- Structured exception inheritance from base `FigmaCommentsError`
- Specific error types for different failure modes
- Metadata enrichment (code, meta, timestamp)

#### 4. Separation of Concerns
- **CLI** - User interaction
- **SDK** - Developer convenience
- **Service** - Business logic
- **Fetcher** - HTTP operations
- **Exceptions** - Error handling

#### 5. Composition Over Inheritance
- SDK uses Service instance (composition)
- Not extending Service class (inheritance)
- More flexible and testable

### Data Flow Examples

#### Comment Creation Flow
```
User Input (CLI)
    ‚Üì
CLI.addComment()
    ‚Üì
SDK.addComment(fileKey, message, options)
    ‚Üì
Service.addComment(fileKey, commentData)
    ‚Üì  [Validation: file key, message length, position format]
    ‚Üì
Service._validateFileKey()
Service._validateCommentData()
Service._formatPosition()
    ‚Üì
Fetcher.request('POST', '/v1/files/{fileKey}/comments', body)
    ‚Üì  [Rate limiting, caching, retry logic]
    ‚Üì
Figma API
    ‚Üì
HTTP Response
    ‚Üì
Service returns parsed comment object
    ‚Üì
SDK returns to caller
    ‚Üì
CLI displays success message
```

#### Reaction Analytics Flow
```
SDK.getEngagementMetrics(fileKey)
    ‚Üì
Service.getFileComments(fileKey)
    ‚Üì  [Fetch all comments]
    ‚Üì
Service.getCommentStatistics(fileKey)
    ‚Üì  [Calculate basic stats]
    ‚Üì
Service.getFileReactionSummary(fileKey)
    ‚Üì
For each comment:
    Service.getCommentReactions(fileKey, commentId)
    ‚Üì  [Parallel API calls]
    Fetcher.request('GET', '/v1/files/{fileKey}/comments/{commentId}/reactions')
    ‚Üì
Aggregate all reactions:
    - Count emojis
    - Identify top emojis
    - Find most reacted comments
    - Calculate user activity
    ‚Üì
SDK combines:
    - Comment stats (total, resolved, threads)
    - Reaction stats (total, top emojis, engagement rate)
    ‚Üì
Return comprehensive engagement metrics
```

### Key Dependencies

#### Production Dependencies
- **@figma-api/fetch** (peer) - Shared HTTP client with rate limiting
- **chalk** - Terminal color output
- **commander** - CLI framework
- **ora** - Terminal spinners
- **dotenv** - Environment variable management
- **fastify** - HTTP server for health checks

#### Development Dependencies
- **jest** - Unit testing framework
- **eslint** - Code linting
- **prettier** - Code formatting

### API Scopes Required

#### Reading Comments
- `file_comments:read` - Read comment content
- No special scopes for basic operations

#### Reading Reactions
- `file_comments:read` - Required to read reactions
- `files:read` - Required to access file metadata

#### Writing Comments/Reactions
- `file_comments:write` - Required for:
  - Adding comments
  - Deleting comments
  - Adding reactions
  - Deleting reactions

**Scope Error Handling:**
The module provides clear error messages when scopes are missing:
```javascript
{
  "error": "Missing required scope: file_comments:read",
  "message": "This operation requires the 'file_comments:read' scope",
  "scope": "file_comments:read"
}
```

### Notable Implementation Patterns

#### 1. Validation-First Approach
- All inputs validated before API calls
- Early failure prevents unnecessary network requests
- Clear validation error messages

#### 2. Graceful Degradation
- Analytics continue on partial failures
- Bulk operations track individual successes/failures
- Optional features don't block core functionality

#### 3. Progressive Enhancement
- Basic operations ‚Üí Advanced features ‚Üí Analytics
- Simple API surface with powerful underlying capabilities
- Convenience methods build on core primitives

#### 4. Consistent Naming
- Verbs: `get`, `add`, `delete`, `toggle`
- Nouns: `Comment`, `Reaction`, `Thread`, `Statistics`
- Patterns: `getBatchX()`, `bulkDoX()`, `getXSummary()`

#### 5. Testability
- Dependency injection enables mocking
- Pure functions for data transformation
- Isolated business logic from HTTP operations

### Performance Considerations

#### Rate Limiting
- Handled by `@figma-api/fetch` (60 requests/minute)
- Token bucket algorithm with burst support
- Automatic retry with backoff

#### Caching
- Optional request caching (5-minute TTL)
- LRU cache implementation
- Configurable via `enableCache` option

#### Bulk Operations
- Batch deletion reduces API calls
- Parallel processing where possible
- Individual error tracking (partial success)

### Error Handling Strategy

#### Error Hierarchy
```
FigmaCommentsError (base)
‚îú‚îÄ‚îÄ ApiError (HTTP errors)
‚îÇ   ‚îú‚îÄ‚îÄ AuthenticationError (401)
‚îÇ   ‚îú‚îÄ‚îÄ AuthorizationError (403)
‚îÇ   ‚îú‚îÄ‚îÄ NotFoundError (404)
‚îÇ   ‚îî‚îÄ‚îÄ RateLimitError (429)
‚îú‚îÄ‚îÄ NetworkError (connectivity)
‚îú‚îÄ‚îÄ ValidationError (input validation)
‚îú‚îÄ‚îÄ CommentError (domain errors)
‚îÇ   ‚îú‚îÄ‚îÄ CommentPermissionError
‚îÇ   ‚îî‚îÄ‚îÄ CommentValidationError
‚îî‚îÄ‚îÄ FileError (file operations)
    ‚îú‚îÄ‚îÄ FileNotFoundError
    ‚îî‚îÄ‚îÄ FileAccessError
```

#### Error Metadata
Every error includes:
- `code` - Machine-readable error code
- `meta` - Additional context (file key, comment ID, etc.)
- `timestamp` - When error occurred
- `message` - Human-readable description

---

## Summary

The Figma Comments Module is a well-architected, comprehensive solution for managing Figma comments with:

**Strengths:**
1. ‚úì Multi-layer architecture (CLI, SDK, Service)
2. ‚úì Comprehensive reaction system with analytics
3. ‚úì Rich analytics and engagement metrics
4. ‚úì Multiple export formats (JSON, CSV, Markdown)
5. ‚úì Bulk operations for efficiency
6. ‚úì Extensive error handling
7. ‚úì Full test coverage (~856 lines of tests)
8. ‚úì CLI for quick operations
9. ‚úì Health check server for monitoring

**Testing:**
- 856 lines of unit tests
- Mock-based testing strategy
- Coverage of core operations and edge cases

**API Surface:**
- 50+ methods across SDK and Service layers
- 18 CLI commands
- Support for comments, reactions, threads, search, analytics

**Dependencies:**
- Relies on shared `@figma-api/fetch` package
- Minimal external dependencies
- Node.js >=20.0.0 required
